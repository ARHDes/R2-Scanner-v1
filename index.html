<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤šäººé›²ç«¯å€‰åº«åŠ©æ‰‹ V11.4</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 800; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .suggestion-item { padding: 10px 14px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .suggestion-item:active { background: #eff6ff; }
        .admin-glow { box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); border: 1px solid rgba(245, 158, 11, 0.5); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .unit-badge { display: inline-block; background: #f1f5f9; color: #64748b; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 4px; font-weight: bold; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 font-sans text-slate-900 text-left">

    <!-- å·¥è™Ÿç™»éŒ„ -->
    <div id="setup-overlay" class="fixed inset-0 bg-blue-600 z-[1000] flex items-center justify-center p-6 hidden">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl text-center border-4 border-blue-400">
            <h2 class="text-2xl font-black mb-2 text-slate-800 tracking-tight">å·¥è™Ÿç™»éŒ„</h2>
            <p class="text-slate-500 text-sm mb-6 font-medium">è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿä»¥é–‹å§‹ä½œæ¥­</p>
            <input type="text" id="operator-name-input" placeholder="è«‹è¼¸å…¥å·¥è™Ÿ" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 mb-4 outline-none focus:border-blue-500 text-center font-bold text-lg">
            <button onclick="saveOperatorName()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-all">ç¢ºèªé€²å…¥</button>
        </div>
    </div>

    <!-- å°èˆªæ¬„ -->
    <nav id="top-nav" class="bg-white border-b border-slate-200 px-4 py-3 sticky top-0 z-50 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-2">
            <div class="flex flex-col">
                <span id="admin-badge" class="hidden text-[8px] font-black bg-amber-500 text-white px-1.5 py-0.5 rounded-full w-fit mb-0.5 uppercase tracking-tighter">ç®¡ç†æ¬Šé™</span>
                <span id="display-operator" class="text-sm font-bold text-slate-700 font-mono tracking-tight text-left">è¼‰å…¥ä¸­...</span>
            </div>
        </div>
        <div class="flex items-center gap-1.5">
            <button id="admin-toggle-btn" onclick="toggleAdminMode()" class="hidden p-2 bg-amber-50 text-amber-600 rounded-lg border border-amber-100"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg></button>
            <button onclick="toggleSettingsManager(true)" class="p-2 bg-slate-100 rounded-lg text-slate-600"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></button>
            <button onclick="logout()" class="p-2 bg-red-50 text-red-500 rounded-lg border border-red-100"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg></button>
        </div>
    </nav>

    <main class="max-w-md mx-auto p-4 space-y-4">
        <!-- åˆ†é  -->
        <div class="flex bg-white rounded-xl p-1 shadow-sm border border-slate-100">
            <button onclick="switchTab('action')" id="tab-action" class="flex-1 py-2 text-sm font-bold tab-active transition-all text-center">æ“ä½œé é¢</button>
            <button onclick="switchTab('stock')" id="tab-stock" class="flex-1 py-2 text-sm font-bold text-slate-400 transition-all text-center">ç¾å­˜åº«å­˜</button>
            <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-2 text-sm font-bold text-slate-400 transition-all text-center">æ­·å²ç´€éŒ„</button>
        </div>

        <!-- A. æ“ä½œé é¢ -->
        <div id="section-action" class="space-y-4">
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 space-y-4">
                <div class="flex gap-2 p-1 bg-slate-50 rounded-xl">
                    <button onclick="setMode('IN')" id="mode-in" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold text-xs">å…¥åº«</button>
                    <button onclick="setMode('OUT')" id="mode-out" class="flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs">å‡ºåº«</button>
                    <button onclick="setMode('COUNT')" id="mode-count" class="flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs">ç›¤é»</button>
                </div>
                
                <div class="space-y-3 relative">
                    <div class="grid grid-cols-2 gap-3 text-left">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">æ©Ÿç¾¤</label>
                            <select id="input-group" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold text-slate-800 outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Unitåç¨±</label>
                            <input type="text" id="input-unit" placeholder="ä¾‹å¦‚ï¼šScribe1" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-left">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">é¡åˆ¥</label>
                            <select id="input-category" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold text-slate-800 outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">ä½ç½® / ç”¨é€”</label>
                            <input type="text" id="input-usage" placeholder="å‚™è¨»..." class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="space-y-1 text-left">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">æ–™è™Ÿ / æ¢ç¢¼</label>
                        <div class="flex gap-2">
                            <input type="text" id="input-sku" oninput="onSkuTyping(this.value)" placeholder="æœå°‹æˆ–æƒææ–™è™Ÿ..." class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 font-mono" autocomplete="off">
                            <button onclick="startScanner()" class="bg-blue-100 text-blue-600 p-3 rounded-xl active:scale-90 transition-transform"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"></path></svg></button>
                        </div>
                        <div id="sku-suggestions" class="absolute left-0 right-0 bg-white border border-slate-200 rounded-xl shadow-xl z-50 mt-1 hidden max-h-60 overflow-y-auto hide-scroll"></div>
                    </div>
                    <div class="space-y-1 text-left">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">ç•°å‹•æ•¸é‡</label>
                        <div class="flex items-center bg-slate-50 rounded-xl p-1">
                            <button onclick="stepQty(-1)" class="w-12 h-10 bg-white rounded-lg shadow-sm font-bold text-xl active:bg-slate-100">-</button>
                            <input type="number" id="input-qty" value="1" class="flex-1 bg-transparent text-center font-black text-xl outline-none">
                            <button onclick="stepQty(1)" class="w-12 h-10 bg-white rounded-lg shadow-sm font-bold text-xl active:bg-slate-100">+</button>
                        </div>
                    </div>
                    <button id="btn-submit" onclick="submitTransaction()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-xl shadow-blue-100 active:scale-95 transition-all">ç¢ºèªæäº¤</button>
                </div>
            </div>
        </div>

        <!-- B. åº«å­˜åˆ†é  -->
        <div id="section-stock" class="hidden space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 space-y-3">
                <div class="flex justify-between items-center px-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-left">è¤‡åˆå¼æœå°‹èˆ‡ç¯©é¸</span>
                    <button onclick="openImportModal()" class="text-blue-600 text-[10px] font-bold border-b border-blue-200">è²¼ä¸Šæ–‡å­—åŒ¯å…¥</button>
                </div>
                <div class="grid grid-cols-2 gap-2 text-left">
                    <select id="filter-group" onchange="applyFilters()" class="bg-slate-50 border-0 rounded-lg px-3 py-2 text-xs font-bold outline-none focus:ring-1 focus:ring-blue-500"><option value="">æ‰€æœ‰æ©Ÿç¾¤</option></select>
                    <select id="filter-unit" onchange="applyFilters()" class="bg-slate-50 border-0 rounded-lg px-3 py-2 text-xs font-bold outline-none focus:ring-1 focus:ring-blue-500"><option value="">æ‰€æœ‰ Unit</option></select>
                </div>
                <div class="relative text-left">
                    <input type="text" id="filter-usage" oninput="applyFilters()" placeholder="æœå°‹ä½ç½®ã€ç”¨é€”æˆ–æ–™è™Ÿé—œéµå­—..." class="w-full bg-slate-50 border-0 rounded-lg px-3 py-2.5 text-xs font-bold outline-none focus:ring-1 focus:ring-blue-500">
                    <div class="absolute right-3 top-2.5 text-slate-300"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div>
                </div>
            </div>
            <div id="stock-list" class="space-y-2"></div>
        </div>

        <div id="section-history" class="hidden space-y-3"><div id="history-list" class="space-y-2"></div></div>
    </main>

    <!-- å½ˆçª—æ¨¡çµ„ -->
    
    <!-- åŒ¯å…¥å½ˆçª— -->
    <div id="import-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[2000] hidden flex items-center justify-center p-6" onclick="closeImportModal()">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 space-y-4 shadow-2xl animate-in fade-in slide-in-from-bottom-4 duration-300" onclick="event.stopPropagation()">
            <div class="text-left"><h3 class="text-xl font-black text-slate-800">æ™ºæ…§æ–‡å­—åŒ¯å…¥</h3><p class="text-[10px] text-slate-400 mt-1 leading-relaxed">æ”¯æ´è‡ªå‹•åˆä½µã€‚è‹¥æ–™è™Ÿå·²å­˜åœ¨ï¼Œå°‡è‡ªå‹•é™„åŠ è‡³æ–°çš„æ©Ÿç¾¤èˆ‡ Unitã€‚<br>æ ¼å¼ï¼šæ©Ÿç¾¤,Unit,é¡åˆ¥,ä½ç½®,æ–™è™Ÿ,æ•¸é‡</p></div>
            <textarea id="import-text-area" placeholder="CSCR,Scribe1,CYLINDER,Clamp,SKU123,0" class="w-full h-48 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl p-3 text-xs font-mono outline-none focus:border-blue-500"></textarea>
            <div class="flex gap-3"><button onclick="closeImportModal()" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-xs text-slate-500">å–æ¶ˆ</button><button onclick="processPastedText()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-xs shadow-lg">é–‹å§‹åŒ¯å…¥</button></div>
        </div>
    </div>

    <!-- å…±ç”¨ä»¶é¸æ“‡/åˆªé™¤å™¨ -->
    <div id="context-picker-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[4500] hidden flex items-center justify-center p-6" onclick="closeContextPicker()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 space-y-4 shadow-2xl animate-in fade-in zoom-in duration-200 text-left" onclick="event.stopPropagation()">
            <div class="text-center"><h3 id="picker-title" class="text-lg font-black text-slate-800 tracking-tight">å…±ç”¨é›¶ä»¶è™•ç†</h3><p id="picker-desc" class="text-[10px] text-slate-400">è«‹é¸å–æ“ä½œç’°å¢ƒï¼š</p></div>
            <div id="context-options-list" class="space-y-2 max-h-64 overflow-y-auto pr-1 hide-scroll"></div>
            <div id="admin-full-delete-zone" class="hidden pt-2 border-t border-slate-100"><button onclick="executeFullDeleteFromPicker()" class="w-full py-3 bg-red-50 text-red-600 rounded-xl font-bold text-xs active:bg-red-100">æ°¸ä¹…å¾¹åº•åˆªé™¤æ­¤æ–™è™Ÿ</button></div>
            <button onclick="closeContextPicker()" class="w-full py-3 bg-slate-100 rounded-xl font-bold text-slate-500 text-sm">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å±¬æ€§è­¦å‘Š/å…±ç”¨ä»¶è©¢å•å½ˆçª— -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[4000] hidden flex items-center justify-center p-6 text-left">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 space-y-4 shadow-2xl">
            <h3 id="confirm-title" class="text-lg font-black text-slate-800 tracking-tight">æ–™è™Ÿè¡çª</h3>
            <p id="confirm-modal-msg" class="text-xs text-slate-500 leading-relaxed"></p>
            <div id="confirm-standard-actions" class="flex flex-col gap-2 pt-2"></div>
        </div>
    </div>

    <!-- ç®¡ç†è¨­å®šå½ˆçª— -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-6" onclick="toggleSettingsManager(false)">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 space-y-6 shadow-2xl text-left" onclick="event.stopPropagation()">
            <div class="space-y-3">
                <h3 class="text-sm font-black border-l-4 border-blue-500 pl-2 text-slate-800 uppercase tracking-tighter">é¡åˆ¥ç®¡ç†</h3>
                <div id="admin-cat-controls" class="hidden flex gap-2"><input type="text" id="new-category-name" placeholder="æ–°é¡åˆ¥..." class="flex-1 bg-slate-50 rounded-xl px-3 py-2 text-sm outline-none"><button onclick="addNewCategory()" class="bg-blue-600 text-white px-4 rounded-xl font-bold active:scale-90">+</button></div>
                <div id="category-list-manager" class="space-y-2 max-h-32 overflow-y-auto pr-1 hide-scroll font-mono"></div>
            </div>
            <div class="space-y-3">
                <h3 class="text-sm font-black border-l-4 border-amber-500 pl-2 text-slate-800 uppercase tracking-tighter">æ©Ÿç¾¤ç®¡ç†</h3>
                <div id="admin-group-controls" class="hidden flex gap-2"><input type="text" id="new-group-name" placeholder="æ–°æ©Ÿç¾¤..." class="flex-1 bg-slate-50 rounded-xl px-3 py-2 text-sm outline-none"><button onclick="addNewGroup()" class="bg-amber-500 text-white px-4 rounded-xl font-bold active:scale-90">+</button></div>
                <div id="group-list-manager" class="space-y-2 max-h-32 overflow-y-auto pr-1 hide-scroll font-mono"></div>
            </div>
            <button onclick="toggleSettingsManager(false)" class="w-full py-3 bg-slate-100 rounded-xl font-bold text-slate-500 text-sm">é—œé–‰</button>
        </div>
    </div>

    <!-- è¼”åŠ©ç•«é¢ -->
    <div id="scanner-view" class="fixed inset-0 bg-black z-[3000] hidden flex flex-col"><div id="reader" class="flex-1"></div><div class="p-10 bg-black text-center"><button onclick="stopScanner()" class="bg-red-600 text-white px-10 py-4 rounded-2xl font-black">é—œé–‰æƒæ</button></div></div>
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur text-white px-6 py-3 rounded-full text-[10px] font-bold opacity-0 transition-all z-[5000] pointer-events-none shadow-2xl text-center"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, serverTimestamp, getDoc, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDlrIJR7wKN_lzcTiC2ohe8jeXaC3mZXdk", authDomain: "storage-3098e.firebaseapp.com", projectId: "storage-3098e", storageBucket: "storage-3098e.firebasestorage.app", messagingSenderId: "947569272384", appId: "1:947569272384:web:badb6b78e91e36cee5a1a5", measurementId: "G-1WEQXLGR20" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'shared-ims-storage-3098e'; 
        const ADMIN_ID = '22009866';

        let operatorId = localStorage.getItem('ims_op_v11_fix'); 
        let currentMode = 'IN';
        let adminModeActive = false;
        let categories = [];
        let machineGroups = [];
        let html5QrCode = null;
        let pendingTransaction = null;
        let activePickerSku = null;

        async function init() {
            if (!operatorId) document.getElementById('setup-overlay').classList.remove('hidden');
            else { document.getElementById('display-operator').innerText = `ğŸ‘¤ å·¥è™Ÿ: ${operatorId}`; checkAdminStatus(); }
            try { await signInAnonymously(auth); onAuthStateChanged(auth, (u) => { if (u) loadCloudData(); }); } catch (err) { console.error(err); }
        }

        function checkAdminStatus() {
            if (operatorId === ADMIN_ID) {
                ['admin-toggle-btn','admin-cat-controls','admin-group-controls'].forEach(id => document.getElementById(id).classList.remove('hidden'));
                document.getElementById('display-operator').classList.add('text-amber-600');
            }
        }

        window.saveOperatorName = () => {
            const id = document.getElementById('operator-name-input').value.trim();
            if (!id) return;
            localStorage.setItem('ims_op_v11_fix', id);
            location.reload();
        };

        window.logout = () => { if (confirm("ç¢ºå®šè¦ç™»å‡ºä¸¦æ›äººå—ï¼Ÿ")) { localStorage.removeItem('ims_op_v11_fix'); location.reload(); } };

        window.toggleAdminMode = () => {
            adminModeActive = !adminModeActive;
            const nav = document.getElementById('top-nav');
            nav.classList.toggle('admin-glow', adminModeActive);
            nav.classList.toggle('bg-amber-50', adminModeActive);
            document.getElementById('admin-badge').classList.toggle('hidden', !adminModeActive);
            renderStock(window.cachedStock || []); renderCats(); renderGroups();
            showToast(adminModeActive ? "âš ï¸ å·²é–‹å•Ÿç·¨è¼¯èˆ‡åˆªé™¤æ¬Šé™" : "å·²é—œé–‰ç®¡ç†æ¨¡å¼");
        };

        function loadCloudData() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), (s) => {
                categories = s.exists() ? s.data().list : ['åŸ¹æ—', 'æ°£å£“ç¼¸']; renderCats();
            });
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'groups', 'all'), (s) => {
                machineGroups = s.exists() ? s.data().list : ['CSCR', 'CST', 'CV']; renderGroups();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'stock'), (s) => {
                const data = s.docs.map(d => d.data());
                window.cachedStock = data;
                updateFilterOptions(data); applyFilters();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'history'), (s) => {
                const logs = s.docs.map(d => d.data()).sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderHistory(logs);
            });
        }

        // --- æ ¸å¿ƒåŒ¯å…¥èˆ‡æ™ºæ…§åˆä½µç®—æ³• (V11.4 æ›´æ–°é‡é») ---
        window.processPastedText = async () => {
            const text = document.getElementById('import-text-area').value.trim();
            if (!text) return showToast("âš ï¸ è«‹è¼¸å…¥å…§å®¹");

            showToast("â³ æ­£åœ¨åŸ·è¡Œæ™ºæ…§åˆä½µ...");
            const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
            if (rows.length === 0) return;

            const batch = writeBatch(db);
            const inputDataMap = new Map(); // ç”¨æ–¼åœ¨æœ¬åœ°å…ˆè¡Œåˆä½µåŒæ–™è™Ÿå¤šè¡Œ
            let count = 0;
            let newCats = new Set(categories);
            let newGroups = new Set(machineGroups);

            try {
                let start = (rows[0].includes("æ©Ÿç¾¤") || rows[0].includes("æ–™è™Ÿ")) ? 1 : 0;
                
                // ç¬¬ä¸€éšæ®µï¼šå°‡è²¼ä¸Šçš„æ–‡å­—å…§éƒ¨åˆä½µ
                for (let i = start; i < rows.length; i++) {
                    const c = rows[i].split(",").map(s => s.trim().replace(/^"|"$/g, ""));
                    if (c.length < 5) continue;
                    
                    const [group, unit, cat, usage, sku, qtyStr] = c;
                    const qty = parseInt(qtyStr) || 0;
                    if (!sku) continue;

                    if (!inputDataMap.has(sku)) {
                        inputDataMap.set(sku, { groupSet: new Set([group]), unitSet: new Set([unit]), cat, usageSet: new Set([usage]), qty });
                    } else {
                        const existingInMap = inputDataMap.get(sku);
                        existingInMap.groupSet.add(group);
                        existingInMap.unitSet.add(unit);
                        if (usage) existingInMap.usageSet.add(usage);
                        // æ•¸é‡ä»¥å‡ºç¾çš„æœ€å¾Œä¸€è¡Œæˆ–æ˜¯ç´¯åŠ ï¼Ÿé€™è£¡æˆ‘å€‘æ¡æ¨£åˆå§‹åŒ–é‚è¼¯ï¼šè‹¥é‡è¤‡å‡ºç¾å‰‡å–æœ€å¾Œä¸€è¡Œ
                        existingInMap.qty = qty; 
                    }
                    if (cat) newCats.add(cat);
                    if (group) newGroups.add(group);
                }

                // ç¬¬äºŒéšæ®µï¼šèˆ‡é›²ç«¯è³‡æ–™åˆä½µä¸¦å¯«å…¥ Batch
                for (const [sku, input] of inputDataMap) {
                    const cloudItem = window.cachedStock.find(i => i.sku === sku);
                    
                    let finalGroup, finalUnit, finalUsage, finalCat;
                    
                    if (cloudItem) {
                        // åˆä½µé›²ç«¯ç¾æœ‰è³‡æ–™
                        const gSet = new Set(cloudItem.group.split(",").map(s => s.trim()));
                        const uSet = new Set(cloudItem.unit.split(",").map(s => s.trim()));
                        const usageSet = new Set((cloudItem.usage || "").split(",").map(s => s.trim()));

                        input.groupSet.forEach(g => gSet.add(g));
                        input.unitSet.forEach(u => uSet.add(u));
                        input.usageSet.forEach(us => usageSet.add(us));

                        finalGroup = Array.from(gSet).filter(Boolean).join(", ");
                        finalUnit = Array.from(uSet).filter(Boolean).join(", ");
                        finalUsage = Array.from(usageSet).filter(Boolean).join(", ");
                        finalCat = input.cat || cloudItem.category;
                    } else {
                        // å…¨æ–°æ–™è™Ÿ
                        finalGroup = Array.from(input.groupSet).join(", ");
                        finalUnit = Array.from(input.unitSet).join(", ");
                        finalUsage = Array.from(input.usageSet).join(", ");
                        finalCat = input.cat;
                    }

                    batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku), {
                        sku,
                        group: finalGroup,
                        unit: finalUnit,
                        category: finalCat || "å…¶ä»–",
                        usage: finalUsage || "",
                        qty: input.qty,
                        lastOp: operatorId + " (æ‰¹æ¬¡åˆä½µ)",
                        time: serverTimestamp()
                    });
                    count++;
                }

                // æ›´æ–°é¸å–®æ¸…å–®
                if (newCats.size > categories.length) batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), { list: Array.from(newCats) });
                if (newGroups.size > machineGroups.length) batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'groups', 'all'), { list: Array.from(newGroups) });

                await batch.commit();
                showToast(`âœ… å·²æˆåŠŸåˆä½µåŒ¯å…¥ ${count} ç­†æ–™è™Ÿ`);
                document.getElementById('import-text-area').value = ""; closeImportModal();
            } catch (e) { console.error(e); showToast("âŒ è§£ææˆ–åŒ¯å…¥å¤±æ•—"); }
        };

        // --- å…¶é¤˜åŠŸèƒ½é‚è¼¯ ---
        window.applyFilters = () => {
            const g = document.getElementById('filter-group').value;
            const u = document.getElementById('filter-unit').value;
            const s = document.getElementById('filter-usage').value.trim().toLowerCase();
            let filtered = window.cachedStock || [];
            if (g) filtered = filtered.filter(i => (i.group || "").includes(g));
            if (u) filtered = filtered.filter(i => (i.unit || "").includes(u));
            if (s) filtered = filtered.filter(i => (i.usage||'').toLowerCase().includes(s) || (i.sku||'').toLowerCase().includes(s) || (i.category||'').toLowerCase().includes(s));
            renderStock(filtered);
        };

        window.autoFillStock = (sku) => {
            const item = window.cachedStock.find(i => i.sku === sku);
            if (!item) return;
            const units = (item.unit || "").split(",").map(u => u.trim()).filter(Boolean);
            const groups = (item.group || "").split(",").map(g => g.trim()).filter(Boolean);
            const usages = (item.usage || "").split(",").map(u => u.trim()).filter(Boolean);
            if (units.length > 1) {
                const list = document.getElementById('context-options-list'); list.innerHTML = "";
                for (let i = 0; i < units.length; i++) {
                    const g = groups[i] || groups[0] || ""; const u = units[i]; const us = usages[i] || "";
                    const btn = document.createElement('button');
                    btn.className = "w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-left active:bg-blue-50 transition-all mb-2";
                    btn.innerHTML = `<div class="flex justify-between items-center text-[11px]"><div><span class="font-black bg-blue-100 text-blue-600 px-2 py-0.5 rounded uppercase font-mono">${g}</span><div class="font-bold text-slate-800 mt-1">${u}</div><div class="text-slate-400 italic">${us || 'ç„¡å‚™è¨»'}</div></div><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="3"><path d="M5 12h14M12 5l7 7-7 7"/></svg></div>`;
                    btn.onclick = () => { applyContext(sku, g, u, item.category, us); closeContextPicker(); };
                    list.appendChild(btn);
                }
                document.getElementById('context-picker-modal').classList.remove('hidden');
            } else { applyContext(sku, groups[0]||"", units[0]||"", item.category, usages[0]||""); }
        };

        function applyContext(sku, g, u, cat, usage) {
            document.getElementById('input-sku').value = sku;
            document.getElementById('input-group').value = machineGroups.includes(g) ? g : "";
            document.getElementById('input-unit').value = u;
            document.getElementById('input-category').value = cat;
            document.getElementById('input-usage').value = usage;
            switchTab('action'); showToast(`å·²å¸¶å…¥ç’°å¢ƒ: ${u}`);
        }

        window.submitTransaction = async () => {
            const sku = document.getElementById('input-sku').value.trim();
            const group = document.getElementById('input-group').value;
            const unit = document.getElementById('input-unit').value.trim();
            const cat = document.getElementById('input-category').value;
            const usage = document.getElementById('input-usage').value.trim();
            const qty = parseInt(document.getElementById('input-qty').value) || 0;
            if (!sku || !group || !unit || qty < 0) return showToast("âš ï¸ è«‹å¡«å¯«å®Œæ•´è³‡æ–™");
            const existing = window.cachedStock.find(i => i.sku === sku);
            if (existing && (!existing.group.includes(group) || !existing.unit.includes(unit) || existing.category !== cat)) {
                pendingTransaction = { sku, group, unit, cat, usage, qty, existing };
                showConfirmModal("å»ºç«‹å…±ç”¨é—œä¿‚", `æ–™è™Ÿ <b>${sku}</b> ç’°å¢ƒè¡çªï¼š<br>é›²ç«¯ï¼š${existing.unit}<br>ç›®å‰ï¼š${unit}<br><br>è«‹å•å¦‚ä½•è™•ç†ï¼Ÿ`, [
                    { text: "è¨­ç‚ºå…±ç”¨é›¶ä»¶ (ä¿ç•™å…©è€…)", color: "bg-blue-600", action: () => handleConflictResponse('MERGE') },
                    { text: "å¼·åˆ¶è¦†è“‹é›²ç«¯è¨­å®š", color: "bg-amber-500", action: () => handleConflictResponse('OVERWRITE') },
                    { text: "å–æ¶ˆ", color: "bg-slate-100", textColor: "text-slate-500", action: () => closeConfirmModal() }
                ]);
                return;
            }
            executeCommit(sku, group, unit, cat, usage, qty);
        };

        window.handleConflictResponse = (action) => {
            closeConfirmModal();
            let { sku, group, unit, cat, usage, qty, existing } = pendingTransaction;
            if (action === 'MERGE') {
                const gSet = new Set(existing.group.split(",").map(u => u.trim()));
                const uSet = new Set(existing.unit.split(",").map(u => u.trim()));
                const usageSet = new Set((existing.usage || "").split(",").map(u => u.trim()));
                gSet.add(group); uSet.add(unit); if(usage) usageSet.add(usage);
                group = Array.from(gSet).join(", "); unit = Array.from(uSet).join(", "); usage = Array.from(usageSet).join(", ");
            }
            executeCommit(sku, group, unit, cat, usage, qty);
        };

        async function executeCommit(sku, group, unit, cat, usage, qty) {
            const btn = document.getElementById('btn-submit'); btn.disabled = true;
            try {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku);
                const snap = await getDoc(ref);
                let oldQty = snap.exists() ? snap.data().qty : 0;
                let newQty = currentMode === 'IN' ? oldQty + qty : (currentMode === 'OUT' ? oldQty - qty : qty);
                await setDoc(ref, { sku, group, unit, qty: newQty, category: cat, usage, lastOp: operatorId, time: serverTimestamp() });
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), { sku, type: currentMode, change: qty, after: newQty, op: operatorId, group, unit, timestamp: serverTimestamp() });
                showToast("âœ… å·²åŒæ­¥è‡³é›²ç«¯"); document.getElementById('input-sku').value = ""; document.getElementById('input-qty').value = "1";
            } catch (e) { showToast("âŒ æ›´æ–°å¤±æ•—"); }
            finally { btn.disabled = false; setMode(currentMode); }
        }

        // --- UI & å·¥å…· ---
        function updateFilterOptions(data) {
            const gSet = new Set(); const uSet = new Set();
            data.forEach(i => { (i.group||"").split(",").forEach(s => gSet.add(s.trim())); (i.unit||"").split(",").forEach(s => uSet.add(s.trim())); });
            document.getElementById('filter-group').innerHTML = '<option value="">æ‰€æœ‰æ©Ÿç¾¤</option>' + Array.from(gSet).filter(Boolean).sort().map(g => `<option value="${g}">${g}</option>`).join('');
            document.getElementById('filter-unit').innerHTML = '<option value="">æ‰€æœ‰ Unit</option>' + Array.from(uSet).filter(Boolean).sort().map(u => `<option value="${u}">${u}</option>`).join('');
        }
        window.onSkuTyping = (v) => {
            const c = document.getElementById('sku-suggestions'); if (!v || !window.cachedStock) { c.classList.add('hidden'); return; }
            const m = window.cachedStock.filter(i => i.sku.toLowerCase().includes(v.toLowerCase())).slice(0, 8);
            if (m.length > 0) { c.innerHTML = m.map(i => `<div class="suggestion-item" onclick="applySuggestion('${i.sku}')"><div class="font-bold text-xs font-mono">${i.sku}</div><div class="text-[8px] text-slate-400">ç¾å­˜ï¼š${i.qty}</div></div>`).join(''); c.classList.remove('hidden'); } else c.classList.add('hidden');
        };
        window.applySuggestion = (sku) => { autoFillStock(sku); document.getElementById('sku-suggestions').classList.add('hidden'); };
        window.openImportModal = () => document.getElementById('import-modal').classList.remove('hidden');
        window.closeImportModal = () => document.getElementById('import-modal').classList.add('hidden');
        window.closeContextPicker = () => document.getElementById('context-picker-modal').classList.add('hidden');
        window.showConfirmModal = (title, msg, actions) => {
            document.getElementById('confirm-title').innerText = title; document.getElementById('confirm-modal-msg').innerHTML = msg;
            const container = document.getElementById('confirm-standard-actions'); container.innerHTML = "";
            actions.forEach(a => { const btn = document.createElement('button'); btn.className = `w-full py-3 rounded-xl font-bold text-xs ${a.color} ${a.textColor || 'text-white'}`; btn.innerText = a.text; btn.onclick = a.action; container.appendChild(btn); });
            document.getElementById('confirm-modal').classList.remove('hidden');
        };
        window.closeConfirmModal = () => document.getElementById('confirm-modal').classList.add('hidden');
        window.deleteStockItem = (sku) => {
            const item = window.cachedStock.find(i => i.sku === sku); if (!item) return;
            const units = item.unit.split(",").map(u => u.trim());
            if (units.length > 1) showContextPicker(item, item.group.split(","), units, (item.usage||"").split(","), true);
            else { window.showConfirmModal("æ°¸ä¹…åˆªé™¤", `ç¢ºå®šåˆªé™¤æ–™è™Ÿ ${sku}ï¼Ÿ`, [{ text: "ç¢ºå®šåˆªé™¤", color: "bg-red-600", action: () => executeFullDelete(sku) }, { text: "å–æ¶ˆ", color: "bg-slate-100", textColor: "text-slate-500", action: () => closeConfirmModal() }]); }
        };
        async function executeFullDelete(sku) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku)); showToast(`ğŸ—‘ï¸ å·²åˆªé™¤: ${sku}`); closeConfirmModal(); closeContextPicker(); }
        async function executePartialDelete(sku, idx) {
            const item = window.cachedStock.find(i => i.sku === sku);
            const g = item.group.split(",").map(s => s.trim()); const u = item.unit.split(",").map(s => s.trim()); const us = (item.usage||"").split(",").map(s => s.trim());
            g.splice(idx, 1); u.splice(idx, 1); if (us[idx] !== undefined) us.splice(idx, 1);
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku), { ...item, group: g.join(", "), unit: u.join(", "), usage: us.join(", "), lastOp: operatorId + " (ç§»é™¤ç’°å¢ƒ)" });
            showToast("å·²ç§»é™¤ç‰¹å®šç’°å¢ƒ"); closeContextPicker();
        }
        window.executeFullDeleteFromPicker = () => { if(confirm(`å¾¹åº•åˆªé™¤ ${activePickerSku}ï¼Ÿ`)) executeFullDelete(activePickerSku); };
        function showContextPicker(item, groups, units, usages, isDeleteMode = false) {
            activePickerSku = item.sku; const list = document.getElementById('context-options-list'); list.innerHTML = "";
            document.getElementById('picker-title').innerText = isDeleteMode ? "é¸æ“‡è¦ç§»é™¤çš„ç’°å¢ƒ" : "åµæ¸¬ç‚ºå…±ç”¨é›¶ä»¶";
            document.getElementById('picker-desc').innerText = isDeleteMode ? "é»æ“Šä»¥æ‹¿æ‰ç’°å¢ƒé—œè¯ï¼š" : "é»æ“Šè¦å¸¶å…¥çš„æ“ä½œç’°å¢ƒï¼š";
            document.getElementById('admin-full-delete-zone').classList.toggle('hidden', !isDeleteMode);
            for (let i = 0; i < units.length; i++) {
                const g = groups[i] || groups[0] || ""; const u = units[i]; const us = usages[i] || "";
                const btn = document.createElement('button'); btn.className = `w-full p-4 border rounded-2xl text-left mb-2 ${isDeleteMode?'bg-red-50 border-red-100':'bg-slate-50 border-slate-200'}`;
                btn.innerHTML = `<div class="flex justify-between items-center text-[10px]"><div><span class="font-black ${isDeleteMode?'text-red-600':'text-blue-600'} uppercase">${g}</span><div class="font-bold text-slate-800 mt-0.5">${u}</div><div class="text-slate-400 italic">${us||'ç„¡å‚™è¨»'}</div></div><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="${isDeleteMode?'M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6':'M5 12h14M12 5l7 7-7 7'}"/></svg></div>`;
                btn.onclick = () => isDeleteMode ? executePartialDelete(item.sku, i) : (applyContext(item.sku, g, u, item.category, us), closeContextPicker());
                list.appendChild(btn);
            }
            document.getElementById('context-picker-modal').classList.remove('hidden');
        }
        window.addNewCategory = async () => { const i = document.getElementById('new-category-name'); if (!i.value.trim()) return; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), { list: [...categories, i.value.trim()] }); i.value = ""; };
        window.removeCategory = async (n) => { if (confirm(`ç§»é™¤é¡åˆ¥ ${n}ï¼Ÿ`)) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), { list: categories.filter(x => x !== n) }); };
        window.addNewGroup = async () => { const i = document.getElementById('new-group-name'); if (!i.value.trim()) return; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', 'all'), { list: [...machineGroups, i.value.trim()] }); i.value = ""; };
        window.removeGroup = async (n) => { if (confirm(`ç§»é™¤æ©Ÿç¾¤ ${n}ï¼Ÿ`)) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', 'all'), { list: machineGroups.filter(x => x !== n) }); };
        function renderCats() { document.getElementById('input-category').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join(''); document.getElementById('category-list-manager').innerHTML = categories.map(c => `<div class="flex justify-between items-center bg-slate-50 p-2 rounded-xl mb-1"><span class="text-xs font-bold">${c}</span>${adminModeActive ? `<button onclick="removeCategory('${c}')" class="text-red-500 font-bold text-[9px]">ç§»é™¤</button>` : ''}</div>`).join(''); }
        function renderGroups() { document.getElementById('input-group').innerHTML = '<option value="" disabled selected>æ©Ÿç¾¤æ¸…å–®</option>' + machineGroups.map(g => `<option value="${g}">${g}</option>`).join(''); document.getElementById('group-list-manager').innerHTML = machineGroups.map(g => `<div class="flex justify-between items-center bg-slate-50 p-2 rounded-xl mb-1"><span class="text-xs font-bold font-mono">${g}</span>${adminModeActive ? `<button onclick="removeGroup('${g}')" class="text-red-500 text-[9px]">ç§»é™¤</button>` : ''}</div>`).join(''); }
        function renderStock(data) {
            const list = document.getElementById('stock-list'); if (!data.length) return list.innerHTML = '<div class="py-20 text-slate-300 text-xs text-center italic tracking-widest">ç„¡åŒ¹é…è³‡æ–™</div>';
            list.innerHTML = data.map(i => `
                <div class="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm active:bg-slate-50 transition-all text-left" onclick="autoFillStock('${i.sku}')">
                    <div class="flex-1 pr-2">
                        <div class="mb-1 flex flex-wrap gap-1">${(i.unit||"").split(",").map(u => `<span class="unit-badge">${u.trim()}</span>`).join('')}</div>
                        <div class="font-black text-slate-800 text-sm font-mono leading-none break-all">${i.sku}</div>
                        <div class="text-[8px] text-slate-400 mt-1.5 uppercase font-medium tracking-tight">${i.category} | ä½ï¼š${i.usage||'æœªè¨»æ˜'}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-xl font-black ${i.qty < 0 ? 'text-red-500' : 'text-slate-800'} font-mono">${i.qty}</div>
                        ${adminModeActive ? `<button onclick="event.stopPropagation(); deleteStockItem('${i.sku}')" class="p-2 bg-red-50 text-red-500 rounded-lg active:scale-90"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>` : ''}
                    </div>
                </div>`).join('');
        }
        function renderHistory(logs) { document.getElementById('history-list').innerHTML = logs.slice(0, 20).map(l => `<div class="bg-white p-3 rounded-xl border border-slate-50 flex justify-between items-center text-[9px] shadow-sm text-left"><div class="text-left font-mono"><div class="font-bold text-slate-800">${l.sku}</div><div class="text-slate-400 tracking-tight">å·¥è™Ÿ: ${l.op} â€¢ ${l.timestamp ? new Date(l.timestamp.toMillis()).toLocaleTimeString() : '...'}</div></div><div class="font-black ${l.type==='IN'?'text-blue-500':(l.type==='OUT'?'text-orange-500':'text-emerald-500')}">${l.type} ${l.change}</div></div>`).join(''); }
        window.setMode = (m) => { currentMode = m; ['IN','OUT','COUNT'].forEach(x => document.getElementById(`mode-${x.toLowerCase()}`).className = x === m ? 'flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold text-xs shadow-md' : 'flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs'); const btn = document.getElementById('btn-submit'); btn.innerText = m==='IN'?'ç¢ºèªå…¥åº«':(m==='OUT'?'ç¢ºèªå‡ºåº«':'ä¿®æ­£ç›¤é»'); btn.style.backgroundColor = m==='IN'?'#2563eb':(m==='OUT'?'#f97316':'#10b981'); };
        window.switchTab = (t) => { ['action','stock','history'].forEach(x => { document.getElementById(`section-${x}`).classList.toggle('hidden', x !== t); document.getElementById(`tab-${x}`).classList.toggle('tab-active', x === t); }); };
        window.stepQty = (v) => { const i = document.getElementById('input-qty'); i.value = Math.max(0, (parseInt(i.value) || 0) + v); };
        window.toggleSettingsManager = (s) => document.getElementById('settings-modal').classList.toggle('hidden', !s);
        window.startScanner = async () => { document.getElementById('scanner-view').classList.remove('hidden'); html5QrCode = new Html5Qrcode("reader"); await html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 240 }, (t) => { document.getElementById('input-sku').value = t; window.onSkuTyping(t); stopScanner(); }).catch(() => stopScanner()); };
        window.stopScanner = () => { if (html5QrCode) html5QrCode.stop().then(() => document.getElementById('scanner-view').classList.add('hidden')); else document.getElementById('scanner-view').classList.add('hidden'); };
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = "1"; setTimeout(() => t.style.opacity = "0", 2000); }
        document.addEventListener('click', (e) => { if (e.target.id !== 'input-sku') document.getElementById('sku-suggestions').classList.add('hidden'); });
        init();
    </script>
</body>
</html>

