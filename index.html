<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›²ç«¯å€‰åº«åŠ©æ‰‹ V7 - ç©©å®šç‰ˆ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 800; }
        .hide-scroll::-webkit-scrollbar { width: 0; background: transparent; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 font-sans">

    <!-- äººå“¡è¨­ç½® -->
    <div id="setup-overlay" class="fixed inset-0 bg-blue-600 z-[1000] flex items-center justify-center p-6 hidden">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl text-center">
            <h2 class="text-2xl font-black mb-2 text-slate-800">äººå“¡è¨­ç½®</h2>
            <p class="text-slate-500 text-sm mb-6">è«‹è¼¸å…¥æ‚¨çš„å§“åï¼Œä»¥ä¾¿åŒæ­¥ç´€éŒ„ã€‚</p>
            <input type="text" id="operator-name-input" placeholder="ä¾‹å¦‚ï¼šå€‰ç®¡-å°æ˜" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 mb-4 outline-none focus:border-blue-500 text-center font-bold">
            <button onclick="saveOperatorName()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <!-- å°èˆªæ¬„ -->
    <nav class="bg-white border-b border-slate-200 px-4 py-3 sticky top-0 z-50 flex justify-between items-center shadow-sm">
        <div class="flex flex-col">
            <span class="text-[10px] font-black text-blue-600 uppercase tracking-tighter">Shared IMS V7</span>
            <span id="display-operator" class="text-sm font-bold text-slate-700">è®€å–ä¸­...</span>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleCategoryManager(true)" class="p-2 bg-slate-100 rounded-lg text-slate-600">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            </button>
            <button onclick="exportAllData()" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold">åŒ¯å‡º</button>
        </div>
    </nav>

    <main class="max-w-md mx-auto p-4 space-y-4">
        <!-- åˆ†é  -->
        <div class="flex bg-white rounded-xl p-1 shadow-sm border border-slate-100">
            <button onclick="switchTab('action')" id="tab-action" class="flex-1 py-2 text-sm font-bold tab-active">æ“ä½œ</button>
            <button onclick="switchTab('stock')" id="tab-stock" class="flex-1 py-2 text-sm font-bold text-slate-400">ç¾å­˜åº«å­˜</button>
            <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-2 text-sm font-bold text-slate-400">æ­·å²ç´€éŒ„</button>
        </div>

        <!-- æ“ä½œå€ -->
        <div id="section-action" class="space-y-4">
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 space-y-4">
                <div class="flex gap-2 p-1 bg-slate-50 rounded-xl">
                    <button onclick="setMode('IN')" id="mode-in" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold text-xs">å…¥åº«</button>
                    <button onclick="setMode('OUT')" id="mode-out" class="flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs">å‡ºåº«</button>
                    <button onclick="setMode('COUNT')" id="mode-count" class="flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs">ç›¤é»</button>
                </div>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">é¡åˆ¥</label>
                            <select id="input-category" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold text-slate-800 outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">ç”¨é€”</label>
                            <input type="text" id="input-usage" placeholder="å‚™è¨»ç”¨é€”..." class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">æ–™è™Ÿ / æ¢ç¢¼</label>
                        <div class="flex gap-2">
                            <input type="text" id="input-sku" placeholder="æƒææˆ–æ‰‹å‹•è¼¸å…¥..." class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="startScanner()" class="bg-blue-100 text-blue-600 p-3 rounded-xl">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">æ•¸é‡</label>
                        <div class="flex items-center bg-slate-50 rounded-xl p-1">
                            <button onclick="stepQty(-1)" class="w-12 h-10 bg-white rounded-lg shadow-sm font-bold text-xl">-</button>
                            <input type="number" id="input-qty" value="1" class="flex-1 bg-transparent text-center font-black text-xl outline-none">
                            <button onclick="stepQty(1)" class="w-12 h-10 bg-white rounded-lg shadow-sm font-bold text-xl">+</button>
                        </div>
                    </div>
                    <button id="btn-submit" onclick="submitTransaction()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-xl shadow-blue-100 active:scale-95 transition-all">ç¢ºèªæäº¤</button>
                </div>
            </div>
        </div>

        <!-- åº«å­˜å€ -->
        <div id="section-stock" class="hidden space-y-3">
            <div class="flex justify-between items-center px-1">
                <span class="text-[10px] font-bold text-slate-400 uppercase">é›²ç«¯å³æ™‚æ¸…å–®</span>
                <button onclick="triggerImport()" class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-lg text-xs font-bold border border-emerald-100 flex items-center gap-1">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                    åŒ¯å…¥æ¸…å–®
                </button>
                <input type="file" id="csv-file-input" class="hidden" accept=".csv" onchange="handleFileSelect(event)">
            </div>
            <div id="stock-list" class="space-y-2"></div>
        </div>

        <!-- æ­·å²å€ -->
        <div id="section-history" class="hidden space-y-3">
            <div id="history-list" class="space-y-2"></div>
        </div>
    </main>

    <!-- æƒæ -->
    <div id="scanner-view" class="fixed inset-0 bg-black z-[2000] hidden flex flex-col">
        <div id="reader" class="flex-1"></div>
        <div class="p-10 bg-black text-center">
            <button onclick="stopScanner()" class="bg-red-600 text-white px-10 py-4 rounded-2xl font-black">å–æ¶ˆæƒæ</button>
        </div>
    </div>

    <!-- é¡åˆ¥ç®¡ç† -->
    <div id="category-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-6" onclick="toggleCategoryManager(false)">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 space-y-4 shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-lg font-black text-slate-800">é¡åˆ¥è‡ªå®šç¾©</h3>
            <div class="flex gap-2">
                <input type="text" id="new-category-name" placeholder="æ–°é¡åˆ¥åç¨±..." class="flex-1 bg-slate-50 rounded-xl px-4 py-2 text-sm outline-none">
                <button onclick="addNewCategory()" class="bg-blue-600 text-white px-4 rounded-xl font-bold">+</button>
            </div>
            <div id="category-list-manager" class="space-y-2 max-h-60 overflow-y-auto pr-1"></div>
            <button onclick="toggleCategoryManager(false)" class="w-full py-3 bg-slate-100 rounded-xl font-bold text-slate-500 text-sm">é—œé–‰</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur text-white px-6 py-3 rounded-full text-xs font-bold opacity-0 transition-all z-[3000] pointer-events-none"></div>

    <!-- Firebase é‚è¼¯ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, serverTimestamp, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // å·²å¡«å…¥ä½ æä¾›çš„æ‰‹æ©Ÿæˆªåœ–è³‡è¨Š
       const firebaseConfig = {
  apiKey: "AIzaSyDlrIJR7wKN_lzcTiC2ohe8jeXaC3mZXdk",
  authDomain: "storage-3098e.firebaseapp.com",
  projectId: "storage-3098e",
  storageBucket: "storage-3098e.firebasestorage.app",
  messagingSenderId: "947569272384",
  appId: "1:947569272384:web:badb6b78e91e36cee5a1a5",
  measurementId: "G-1WEQXLGR20"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'shared-inv-storage-3098e'; // å°ˆç”¨ID

        let operatorName = localStorage.getItem('ims_op_v7');
        let currentMode = 'IN';
        let categories = ['åŸ¹æ—', 'æ°£å£“ç¼¸', 'èºçµ²', 'è€—æ'];
        let html5QrCode = null;

        async function init() {
            if (!operatorName) {
                document.getElementById('setup-overlay').classList.remove('hidden');
            } else {
                document.getElementById('display-operator').innerText = `ğŸ‘¤ ${operatorName}`;
            }

            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => { if (u) loadCloudData(); });
            } catch (err) { alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase è¨­å®šã€‚"); }
        }

        window.saveOperatorName = () => {
            const name = document.getElementById('operator-name-input').value.trim();
            if (!name) return;
            localStorage.setItem('ims_op_v7', name);
            operatorName = name;
            document.getElementById('display-operator').innerText = `ğŸ‘¤ ${name}`;
            document.getElementById('setup-overlay').classList.add('hidden');
        };

        function loadCloudData() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'settings', 'categories'), (s) => {
                if (s.exists()) categories = s.data().list;
                else setDoc(s.ref, { list: categories });
                renderCats();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'stock'), (s) => {
                const data = s.docs.map(d => d.data());
                window.cachedStock = data;
                renderStock(data);
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'history'), (s) => {
                const logs = s.docs.map(d => d.data()).sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderHistory(logs);
            });
        }

        window.submitTransaction = async () => {
            const sku = document.getElementById('input-sku').value.trim();
            const usage = document.getElementById('input-usage').value.trim();
            const qty = parseInt(document.getElementById('input-qty').value) || 0;
            const cat = document.getElementById('input-category').value;

            if (!sku || qty <= 0) return showToast("âš ï¸ è«‹è¼¸å…¥æ–™è™Ÿèˆ‡æ•¸é‡");

            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = "é›²ç«¯åŒæ­¥ä¸­...";

            try {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku);
                const snap = await getDoc(ref);
                let oldQty = snap.exists() ? snap.data().qty : 0;
                let newQty = currentMode === 'IN' ? oldQty + qty : (currentMode === 'OUT' ? oldQty - qty : qty);

                await setDoc(ref, { sku, qty: newQty, category: cat, usage, lastOp: operatorName, time: serverTimestamp() });
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), {
                    sku, type: currentMode, change: qty, after: newQty, op: operatorName, cat, usage, timestamp: serverTimestamp()
                });

                showToast(`âœ… ${sku} å·²æ›´æ–°`);
                document.getElementById('input-sku').value = "";
                document.getElementById('input-usage').value = "";
                document.getElementById('input-qty').value = "1";
            } catch (e) { showToast("âŒ é›²ç«¯æ›´æ–°å¤±æ•—"); }
            finally { btn.disabled = false; setMode(currentMode); }
        };

        window.triggerImport = () => document.getElementById('csv-file-input').click();
        window.handleFileSelect = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => { await processCSV(e.target.result); event.target.value = ''; };
            reader.readAsText(file);
        };

        async function processCSV(csvText) {
            showToast("â³ æ­£åœ¨åŒ¯å…¥...");
            const rows = csvText.split(/\r?\n/).filter(r => r.trim() !== "");
            const batch = writeBatch(db);
            let count = 0;
            let newCats = new Set(categories);

            try {
                for (let i = 1; i < rows.length; i++) {
                    const cols = rows[i].split(",").map(c => c.trim().replace(/^"|"$/g, ""));
                    if (cols.length < 2) continue;
                    const [sku, cat, usage, qtyStr] = cols;
                    const qty = parseInt(qtyStr) || 0;
                    if (!sku) continue;
                    batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku), {
                        sku, category: cat || "å…¶ä»–", usage: usage || "", qty, lastOp: operatorName + " (åŒ¯å…¥)", time: serverTimestamp()
                    });
                    if (cat) newCats.add(cat);
                    count++;
                }
                if (newCats.size > categories.length) {
                    batch.update(doc(db, 'artifacts', appId, 'public', 'settings', 'categories'), { list: Array.from(newCats) });
                }
                await batch.commit();
                showToast(`æˆåŠŸåŒ¯å…¥ ${count} ç­†`);
            } catch (err) { showToast("âŒ åŒ¯å…¥æ ¼å¼éŒ¯èª¤"); }
        }

        function renderCats() {
            document.getElementById('input-category').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('category-list-manager').innerHTML = categories.map(c => `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl">
                    <span class="font-bold text-sm">${c}</span>
                    <button onclick="removeCategory('${c}')" class="text-red-400 text-xs">ç§»é™¤</button>
                </div>`).join('');
        }

        function renderStock(data) {
            const list = document.getElementById('stock-list');
            if (!data.length) return list.innerHTML = '<div class="text-center py-10 text-slate-300 text-sm">ç„¡åº«å­˜</div>';
            list.innerHTML = data.map(i => `
                <div class="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center" onclick="autoFill('${i.sku}','${i.category}','${i.usage||""}')">
                    <div class="flex-1">
                        <div class="flex items-center gap-1 mb-1">
                            <span class="text-[8px] font-black bg-blue-50 text-blue-500 px-1.5 py-0.5 rounded uppercase">${i.category}</span>
                            ${i.usage ? `<span class="text-[8px] font-bold bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">ç”¨é€”: ${i.usage}</span>` : ''}
                        </div>
                        <div class="font-black text-slate-800 text-sm">${i.sku}</div>
                    </div>
                    <div class="text-xl font-black ${i.qty < 0 ? 'text-red-500' : 'text-slate-800'}">${i.qty}</div>
                </div>`).join('');
        }

        function renderHistory(logs) {
            const list = document.getElementById('history-list');
            list.innerHTML = logs.slice(0, 20).map(l => `
                <div class="bg-white p-3 rounded-xl border border-slate-50 flex justify-between items-center text-[10px]">
                    <div>
                        <div class="font-bold text-slate-800">${l.sku}</div>
                        <div class="text-slate-400">${l.op} â€¢ ${l.timestamp ? new Date(l.timestamp.toMillis()).toLocaleTimeString() : '...'}</div>
                    </div>
                    <div class="font-black ${l.type==='IN'?'text-blue-500':(l.type==='OUT'?'text-orange-500':'text-emerald-500')}">${l.type} ${l.change}</div>
                </div>`).join('');
        }

        window.setMode = (m) => {
            currentMode = m;
            ['IN','OUT','COUNT'].forEach(x => {
                document.getElementById(`mode-${x.toLowerCase()}`).className = x === m ? 'flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold text-xs' : 'flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs';
            });
            document.getElementById('btn-submit').innerText = m==='IN'?'ç¢ºèªå…¥åº«':(m==='OUT'?'ç¢ºèªå‡ºåº«':'ç›¤é»å­˜é‡');
            document.getElementById('btn-submit').style.backgroundColor = m==='IN'?'#2563eb':(m==='OUT'?'#f97316':'#10b981');
        };

        window.switchTab = (t) => {
            ['action','stock','history'].forEach(x => {
                document.getElementById(`section-${x}`).classList.toggle('hidden', x !== t);
                document.getElementById(`tab-${x}`).classList.toggle('tab-active', x === t);
            });
        };

        window.autoFill = (s, c, u) => {
            document.getElementById('input-sku').value = s;
            document.getElementById('input-category').value = c;
            document.getElementById('input-usage').value = u;
            switchTab('action');
            showToast(`è¼‰å…¥: ${s}`);
        };

        window.startScanner = async () => {
            document.getElementById('scanner-view').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            await html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 220 }, (t) => {
                document.getElementById('input-sku').value = t;
                stopScanner();
            }).catch(() => stopScanner());
        };

        window.stopScanner = () => {
            if (html5QrCode) html5QrCode.stop().then(() => document.getElementById('scanner-view').classList.add('hidden'));
            else document.getElementById('scanner-view').classList.add('hidden');
        };

        window.stepQty = (v) => {
            const i = document.getElementById('input-qty');
            i.value = Math.max(1, (parseInt(i.value) || 0) + v);
        };

        window.toggleCategoryManager = (s) => document.getElementById('category-modal').classList.toggle('hidden', !s);
        window.addNewCategory = async () => {
            const n = document.getElementById('new-category-name').value.trim();
            if (!n || categories.includes(n)) return;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'settings', 'categories'), { list: [...categories, n] });
            document.getElementById('new-category-name').value = "";
        };

        window.removeCategory = async (n) => {
            if (confirm(`ç§»é™¤é¡åˆ¥ã€Œ${n}ã€ï¼Ÿ`)) await setDoc(doc(db, 'artifacts', appId, 'public', 'settings', 'categories'), { list: categories.filter(x => x !== n) });
        };

        window.exportAllData = () => {
            if (!window.cachedStock) return;
            let csv = "\uFEFFæ–™è™Ÿ,é¡åˆ¥,ç”¨é€”,æ•¸é‡\n";
            window.cachedStock.forEach(i => csv += `"${i.sku}","${i.category}","${i.usage||""}",${i.qty}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Cloud_Inventory.csv`;
            a.click();
        };

        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.opacity = "1";
            setTimeout(() => t.style.opacity = "0", 2000);
        }

        init();
    </script>
</body>
</html>

