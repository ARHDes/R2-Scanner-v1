<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤šäººé›²ç«¯å€‰åº«åŠ©æ‰‹ V13.6</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 800; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .suggestion-item { padding: 10px 14px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .suggestion-item:active { background: #eff6ff; }
        .admin-glow { box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); border: 1px solid rgba(245, 158, 11, 0.5); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .unit-badge { display: inline-block; background: #f1f5f9; color: #334155; padding: 2px 8px; border-radius: 6px; font-size: 10px; margin-right: 4px; font-weight: 900; letter-spacing: -0.2px; border: 1px solid #e2e8f0; }
        .clear-btn { opacity: 0; pointer-events: none; transition: all 0.2s; transform: scale(0.8); }
        .clear-btn.show { opacity: 1; pointer-events: auto; transform: scale(1); }
        #reader__scan_region { border-radius: 20px; overflow: hidden; }
        #reader__dashboard { display: none !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 font-sans text-slate-900 text-left">

    <!-- å·¥è™Ÿç™»éŒ„ (ç§»é™¤ Admin å­—çœ¼) -->
    <div id="setup-overlay" class="fixed inset-0 bg-blue-600 z-[1000] flex items-center justify-center p-6 hidden text-center">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl border-4 border-blue-400">
            <h2 class="text-2xl font-black mb-2 text-slate-800 tracking-tight text-center">å·¥è™Ÿç™»éŒ„</h2>
            <p class="text-slate-500 text-sm mb-6 font-medium text-center">è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿä»¥é–‹å§‹ä½œæ¥­</p>
            <input type="text" id="operator-name-input" placeholder="è«‹è¼¸å…¥å·¥è™Ÿ" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 mb-4 outline-none focus:border-blue-500 text-center font-bold text-lg">
            <button onclick="saveOperatorName()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-all text-center">ç¢ºèªé€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <!-- å°è¦½åˆ— -->
    <nav id="top-nav" class="bg-white border-b border-slate-200 px-4 py-3 sticky top-0 z-50 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-2">
            <div class="flex flex-col text-left">
                <span id="admin-badge" class="hidden text-[8px] font-black bg-amber-500 text-white px-1.5 py-0.5 rounded-full w-fit mb-0.5 uppercase tracking-tighter shadow-sm text-center">ç®¡ç†æ¨¡å¼</span>
                <span id="display-operator" class="text-sm font-bold text-slate-700 font-mono tracking-tight text-left">è¼‰å…¥ä¸­...</span>
            </div>
        </div>
        <div class="flex items-center gap-1.5">
            <button id="admin-toggle-btn" onclick="toggleAdminMode()" class="hidden p-2 bg-amber-50 text-amber-600 rounded-lg border border-amber-100 active:scale-90 transition-transform"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg></button>
            <button onclick="toggleSettingsManager(true)" class="p-2 bg-slate-100 rounded-lg text-slate-600 active:scale-90 transition-transform"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></button>
            <button onclick="logout()" class="p-2 bg-red-50 text-red-500 rounded-lg border border-red-100 active:scale-90 transition-transform"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg></button>
        </div>
    </nav>

    <main class="max-w-md mx-auto p-4 space-y-4">
        <!-- Tabåˆ‡æ› -->
        <div class="flex bg-white rounded-xl p-1 shadow-sm border border-slate-100 text-center">
            <button onclick="switchTab('action')" id="tab-action" class="flex-1 py-2 text-sm font-bold tab-active transition-all">æ“ä½œé é¢</button>
            <button onclick="switchTab('stock')" id="tab-stock" class="flex-1 py-2 text-sm font-bold text-slate-400 transition-all">ç¾å­˜åº«å­˜</button>
            <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-2 text-sm font-bold text-slate-400 transition-all">æ­·å²ç´€éŒ„</button>
        </div>

        <!-- A. æ“ä½œé é¢ -->
        <div id="section-action" class="space-y-4 animate-in fade-in duration-300">
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 space-y-4">
                <div class="flex justify-between items-center px-1">
                    <div class="flex gap-2 p-1 bg-slate-50 rounded-xl flex-1 mr-4">
                        <button onclick="setMode('IN')" id="mode-in" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold text-xs shadow-md">å…¥åº«</button>
                        <button onclick="setMode('OUT')" id="mode-out" class="flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs">å‡ºåº«</button>
                        <button onclick="setMode('COUNT')" id="mode-count" class="flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs">ç›¤é»</button>
                    </div>
                    <button onclick="resetActionFields()" class="text-blue-500 text-[10px] font-bold border-b border-blue-200 pb-0.5 active:text-blue-700">é‡è¨­å…§å®¹</button>
                </div>
                
                <div class="space-y-3 relative text-left">
                    <div class="grid grid-cols-2 gap-3 text-left">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">æ©Ÿç¾¤</label>
                            <select id="input-group" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold text-slate-800 outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Unitåç¨±</label>
                            <input type="text" id="input-unit" placeholder="ä¾‹å¦‚ï¼šPC" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 text-left">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-left">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">é¡åˆ¥</label>
                            <select id="input-category" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold text-slate-800 outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 text-left">ä½ç½® / ç”¨é€”</label>
                            <input type="text" id="input-usage" placeholder="å‚™è¨»ä½ç½®..." class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 text-left">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">å‹è™Ÿ (Model)</label>
                        <input type="text" id="input-model" placeholder="é›¶ä»¶è¦æ ¼å‹è™Ÿ..." class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 font-mono text-left">
                    </div>
                    <div class="space-y-1 text-left">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 text-left">æ–™è™Ÿ / æ¢ç¢¼</label>
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <input type="text" id="input-sku" oninput="onSkuTyping(this.value)" placeholder="æœå°‹æˆ–æƒææ–™è™Ÿ..." class="w-full bg-slate-50 border-0 rounded-xl pl-4 pr-10 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 font-mono text-left" autocomplete="off">
                                <button id="btn-clear-sku" onclick="clearSkuInput()" class="clear-btn absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 hover:text-slate-500 active:scale-90">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
                                </button>
                            </div>
                            <button onclick="startScanner()" class="bg-blue-100 text-blue-600 p-3 rounded-xl active:scale-90 transition-transform"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"></path></svg></button>
                        </div>
                        <div id="sku-suggestions" class="absolute left-0 right-0 bg-white border border-slate-200 rounded-xl shadow-xl z-50 mt-1 hidden max-h-60 overflow-y-auto hide-scroll text-left"></div>
                    </div>
                    <div class="space-y-1 text-center">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 text-left">ç•°å‹•æ•¸é‡</label>
                        <div class="flex items-center bg-slate-50 rounded-xl p-1 text-center">
                            <button onclick="stepQty(-1)" class="w-12 h-10 bg-white rounded-lg shadow-sm font-bold text-xl active:bg-slate-100">-</button>
                            <input type="number" id="input-qty" value="1" class="flex-1 bg-transparent text-center font-black text-xl outline-none text-center">
                            <button onclick="stepQty(1)" class="w-12 h-10 bg-white rounded-lg shadow-sm font-bold text-xl active:bg-slate-100">+</button>
                        </div>
                    </div>
                    <button id="btn-submit" onclick="submitTransaction()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-xl shadow-blue-100 active:scale-95 transition-all text-center">ç¢ºèªå…¥åº«</button>
                </div>
            </div>
        </div>

        <!-- B. åº«å­˜åˆ†é  -->
        <div id="section-stock" class="hidden space-y-4 animate-in fade-in duration-300 text-left">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 space-y-3">
                <div class="flex justify-between items-center px-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-black">æ¢ä»¶ç¯©é¸</span>
                    <div class="flex gap-4 items-center">
                        <button onclick="resetStockFilters()" class="text-orange-500 text-[10px] font-bold border-b border-orange-200 pb-0.5 active:text-orange-700">æ¸…é™¤ç¯©é¸</button>
                        <button onclick="openImportModal()" class="text-blue-600 text-[10px] font-bold border-b border-blue-200 pb-0.5">æ–‡å­—åŒ¯å…¥</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <select id="filter-group" onchange="onFilterGroupChange()" class="bg-slate-50 border-0 rounded-lg px-3 py-2 font-bold outline-none focus:ring-1 focus:ring-blue-500 shadow-inner font-mono"></select>
                    <select id="filter-unit" onchange="onFilterUnitChange()" class="bg-slate-50 border-0 rounded-lg px-3 py-2 font-bold outline-none focus:ring-1 focus:ring-blue-500 shadow-inner font-mono"></select>
                </div>
                <div class="grid grid-cols-1 text-xs">
                    <select id="filter-category" onchange="applyFilters()" class="w-full bg-slate-50 border-0 rounded-lg px-3 py-2.5 font-bold outline-none focus:ring-1 focus:ring-blue-500 shadow-inner"></select>
                </div>
                <div class="relative">
                    <input type="text" id="filter-usage" oninput="toggleSearchClearBtn(this.value); applyFilters();" placeholder="æœå°‹å‹è™Ÿã€æ–™è™Ÿã€ä½ç½®é—œéµå­—..." class="w-full bg-slate-50 border-0 rounded-lg pl-3 pr-10 py-2.5 text-xs font-bold outline-none focus:ring-1 focus:ring-blue-500 shadow-inner">
                    <button id="btn-clear-search" onclick="clearSearchInput()" class="clear-btn absolute right-3 top-1/2 -translate-y-1/2 text-slate-300 hover:text-slate-500 active:scale-90">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>
            <div id="stock-list" class="space-y-2"></div>
        </div>

        <div id="section-history" class="hidden space-y-3 animate-in fade-in duration-300"><div id="history-list" class="space-y-2"></div></div>
    </main>

    <!-- å½ˆçª—ç¾¤ -->
    <div id="comment-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[4800] hidden flex items-center justify-center p-6 text-center" onclick="closeCommentModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 space-y-4 shadow-2xl animate-in fade-in slide-in-from-bottom-4 duration-200 text-left" onclick="event.stopPropagation()">
            <div class="text-center font-black"><h3 class="text-lg text-slate-800 tracking-tight">ç´€éŒ„å‚™è¨» (Comment)</h3><p class="text-[10px] text-slate-400 mt-1">é¸å¡«å…§å®¹ï¼Œå°‡é¡¯ç¤ºæ–¼æ­·å²æ—¥èªŒä¸­</p></div>
            <textarea id="transaction-comment" placeholder="è¼¸å…¥ç•°å‹•åŸå› ..." class="w-full h-24 bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm outline-none focus:border-blue-500 text-left"></textarea>
            <div class="flex gap-3 text-center"><button onclick="closeCommentModal()" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-500 text-sm active:bg-slate-200 transition-colors">å–æ¶ˆ</button><button onclick="confirmTransactionWithComment()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm shadow-lg active:scale-95 transition-all">ç¢ºèªé€å‡º</button></div>
        </div>
    </div>

    <div id="context-picker-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[4500] hidden flex items-center justify-center p-6 text-center" onclick="closeContextPicker()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 space-y-4 shadow-2xl animate-in fade-in zoom-in duration-200 text-left text-left" onclick="event.stopPropagation()">
            <div class="text-center font-black"><h3 id="picker-title" class="text-lg text-slate-800 tracking-tight text-center text-center">æ©Ÿå°ç”¨é€”é¸å–</h3><p id="picker-desc" class="text-[10px] text-slate-400 mt-1 text-center">æ­¤ç‚ºå…±ç”¨æ–™è™Ÿè«‹é¸å–æ©Ÿå°ç”¨é€”</p></div>
            <div id="context-options-list" class="space-y-2 max-h-64 overflow-y-auto pr-1 hide-scroll font-sans text-left"></div>
            <div id="admin-full-delete-zone" class="hidden pt-2 border-t border-slate-100 text-center"><button onclick="executeFullDeleteFromPicker()" class="w-full py-3 bg-red-50 text-red-600 rounded-xl font-bold text-xs active:bg-red-100 transition-colors">æ°¸ä¹…å¾¹åº•åˆªé™¤æ•´å€‹æ–™è™Ÿ</button></div>
            <button onclick="closeContextPicker()" class="w-full py-3 bg-slate-100 rounded-xl font-bold text-slate-500 text-sm active:bg-slate-200 transition-colors text-center text-center">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[4000] hidden flex items-center justify-center p-6 text-left">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 space-y-4 shadow-2xl">
            <h3 id="confirm-title" class="text-lg font-black tracking-tight text-slate-800 text-center">æ“ä½œç¢ºèª</h3>
            <p id="confirm-modal-msg" class="text-xs text-slate-500 leading-relaxed text-left text-left"></p>
            <div id="confirm-standard-actions" class="flex flex-col gap-2 pt-2 text-center text-center"></div>
        </div>
    </div>

    <div id="scanner-view" class="fixed inset-0 bg-black z-[6000] hidden flex flex-col text-left">
        <div class="bg-black/60 p-6 flex justify-between items-center text-white">
            <div class="font-black tracking-tight text-left">æ¢ç¢¼æƒæ</div>
            <button onclick="stopScanner()" class="bg-white/10 p-2 rounded-full active:bg-white/20"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
        </div>
        <div id="reader" class="flex-1 bg-black"></div>
        <div class="p-10 bg-black/80 text-center">
            <p class="text-white/40 text-[10px] font-bold mb-4 uppercase tracking-widest text-center">é•·å½¢æ¢ç¢¼è«‹ç½®æ–¼æ¡†å…§</p>
            <button onclick="stopScanner()" class="w-full bg-red-600 text-white py-4 rounded-2xl font-black active:scale-95 transition-transform text-center">é—œé–‰ç›¸æ©Ÿ</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-emerald-500 text-white px-6 py-3 rounded-full text-[12px] font-bold opacity-0 transition-all z-[7000] pointer-events-none shadow-2xl text-center flex items-center gap-2"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, serverTimestamp, getDoc, writeBatch, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDlrIJR7wKN_lzcTiC2ohe8jeXaC3mZXdk", authDomain: "storage-3098e.firebaseapp.com", projectId: "storage-3098e", storageBucket: "storage-3098e.firebasestorage.app", messagingSenderId: "947569272384", appId: "1:947569272384:web:badb6b78e91e36cee5a1a5", measurementId: "G-1WEQXLGR20" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'shared-ims-storage-3098e'; 
        const ADMIN_ID = 'Admin'; 

        let operatorId = localStorage.getItem('ims_op_v12_final'); 
        let currentMode = 'IN';
        let adminModeActive = false;
        let categories = [];
        let machineGroups = [];
        let html5QrCode = null;
        let pendingTransaction = null;
        let activePickerSku = null;

        async function init() {
            if (!operatorId) document.getElementById('setup-overlay').classList.remove('hidden');
            else { document.getElementById('display-operator').innerText = `ğŸ‘¤ å·¥è™Ÿ: ${operatorId}`; checkAdminStatus(); }
            try { await signInAnonymously(auth); onAuthStateChanged(auth, (u) => { if (u) loadCloudData(); }); } catch (err) { console.error(err); }
        }

        function checkAdminStatus() {
            if (operatorId === ADMIN_ID) {
                document.getElementById('admin-toggle-btn').classList.remove('hidden');
                document.getElementById('display-operator').classList.add('text-amber-600');
            }
        }

        window.saveOperatorName = () => {
            const id = document.getElementById('operator-name-input').value.trim();
            if (!id) return;
            localStorage.setItem('ims_op_v12_final', id);
            location.reload();
        };

        window.logout = () => { if (confirm("ç¢ºå®šè¦ç™»å‡ºä¸¦æ›äººå—ï¼Ÿ")) { localStorage.removeItem('ims_op_v12_final'); location.reload(); } };

        window.toggleAdminMode = () => {
            adminModeActive = !adminModeActive;
            const nav = document.getElementById('top-nav');
            nav.classList.toggle('admin-glow', adminModeActive); nav.classList.toggle('bg-amber-50', adminModeActive);
            document.getElementById('admin-badge').classList.toggle('hidden', !adminModeActive);
            renderStock(window.cachedStock || []);
            renderHistory(window.cachedHistory || []);
        };

        function loadCloudData() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), (s) => {
                categories = s.exists() ? s.data().list : ['åŸ¹æ—', 'æ°£å£“ç¼¸'];
                document.getElementById('input-category').innerHTML = '<option value="" disabled selected>é¡åˆ¥é¸å–®</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
            });
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'groups', 'all'), (s) => {
                machineGroups = s.exists() ? s.data().list : ['CSCR', 'CST', 'CV'];
                document.getElementById('input-group').innerHTML = '<option value="" disabled selected>æ©Ÿç¾¤é¸å–®</option>' + machineGroups.map(g => `<option value="${g}">${g}</option>`).join('');
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'stock'), (s) => {
                const data = s.docs.map(d => d.data());
                window.cachedStock = data;
                refreshInitialFilters(); applyFilters();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'history'), (s) => {
                const logs = s.docs.map(d => ({ ...d.data(), id: d.id })).sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                window.cachedHistory = logs;
                renderHistory(logs);
            });
        }

        window.deleteHistoryItem = async (historyId, historyData) => {
            if (!adminModeActive) return;
            if (!confirm(`ç¢ºå®šè¦å›é€€åº«å­˜ä¸¦åˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ\næ–™è™Ÿï¼š${historyData.sku}\nè®Šå‹•ï¼š${historyData.diff || historyData.change}`)) return;
            try {
                await runTransaction(db, async (tx) => {
                    const stockRef = doc(db, 'artifacts', appId, 'public', 'data', 'stock', historyData.sku);
                    const stockSnap = await tx.get(stockRef);
                    if (!stockSnap.exists()) throw "åº«å­˜æª”ä¸å­˜åœ¨";
                    const cur = parseInt(stockSnap.data().qty) || 0;
                    const change = parseInt(historyData.change) || 0;
                    const diff = parseInt(historyData.diff) || 0;
                    let rb = cur;
                    if (historyData.type === 'IN') rb = cur - change;
                    else if (historyData.type === 'OUT') rb = cur + change;
                    else if (historyData.type === 'COUNT') rb = cur - diff;
                    tx.delete(doc(db, 'artifacts', appId, 'public', 'data', 'history', historyId));
                    tx.update(stockRef, { qty: rb, lastOp: `${operatorId} (Rollback)` });
                });
                showToast("ğŸ—‘ï¸ å·²æˆåŠŸå›é€€åº«å­˜");
            } catch (e) { showToast(`âŒ å¤±æ•—: ${e}`); }
        };

        window.submitTransaction = async () => {
            const sku = document.getElementById('input-sku').value.trim();
            const model = document.getElementById('input-model').value.trim();
            const group = document.getElementById('input-group').value;
            const unit = document.getElementById('input-unit').value.trim();
            const cat = document.getElementById('input-category').value;
            const usage = document.getElementById('input-usage').value.trim();
            const qty = parseInt(document.getElementById('input-qty').value) || 0;
            if (!sku || !group || !unit || !cat || qty < 0) return showToast("âš ï¸ è«‹å¡«å¯«å®Œæ•´è¡¨å–®");
            const existing = window.cachedStock.find(i => i.sku === sku);
            if (existing) {
                const gL = existing.group.split(",").map(s => s.trim());
                const uL = existing.unit.split(",").map(s => s.trim());
                const usL = (existing.usage || "").split(",").map(s => s.trim());
                let match = false;
                for(let i=0; i<Math.max(gL.length, uL.length, usL.length); i++){ if(gL[i] === group && uL[i] === unit && (usL[i]||"") === usage) match = true; }
                if (!match || existing.category !== cat || (existing.model||"") !== model) {
                    pendingTransaction = { sku, group, unit, cat, usage, qty, model, existing };
                    showConfirmModal("å±¬æ€§è¡çª", `èˆ‡é›²ç«¯è¨­å®šä¸ç¬¦ï¼Œæ˜¯å¦è¨­ç‚ºå…±ç”¨ï¼Ÿ`, [
                        { text: "è¨­ç‚ºå…±ç”¨é›¶ä»¶", color: "bg-blue-600", action: () => { closeConfirmModal(); openCommentModal(sku, group, unit, cat, usage, qty, model, 'MERGE'); } },
                        { text: "å¼·åˆ¶è¦†è“‹å±¬æ€§", color: "bg-amber-500", action: () => { closeConfirmModal(); openCommentModal(sku, group, unit, cat, usage, qty, model, 'OVERWRITE'); } },
                        { text: "å–æ¶ˆ", color: "bg-slate-100", textColor: "text-slate-500", action: () => closeConfirmModal() }
                    ]); return;
                }
            }
            openCommentModal(sku, group, unit, cat, usage, qty, model, null);
        };

        function openCommentModal(sku, group, unit, cat, usage, qty, model, conflictAction) {
            pendingTransaction = { sku, group, unit, cat, usage, qty, model, conflictAction };
            document.getElementById('transaction-comment').value = "";
            document.getElementById('comment-modal').classList.remove('hidden');
        }

        window.confirmTransactionWithComment = () => {
            const comment = document.getElementById('transaction-comment').value.trim();
            document.getElementById('comment-modal').classList.add('hidden');
            let { sku, group, unit, cat, usage, qty, model, conflictAction } = pendingTransaction;
            if (conflictAction === 'MERGE') {
                const existing = window.cachedStock.find(i => i.sku === sku);
                const gSet = new Set(existing.group.split(",").map(u => u.trim())); const uSet = new Set(existing.unit.split(",").map(u => u.trim())); const usageSet = new Set((existing.usage || "").split(",").map(u => u.trim()));
                gSet.add(group); uSet.add(unit); if(usage) usageSet.add(usage); group = Array.from(gSet).join(", "); unit = Array.from(uSet).join(", "); usage = Array.from(usageSet).join(", ");
            }
            executeCommit(sku, group, unit, cat, usage, qty, model, comment);
        };

        async function executeCommit(sku, group, unit, cat, usage, qty, model, comment) {
            const btn = document.getElementById('btn-submit'); btn.disabled = true;
            try {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku); const snap = await getDoc(ref);
                const old = snap.exists() ? (parseInt(snap.data().qty) || 0) : 0;
                let nw; let df = null;
                if (currentMode === 'COUNT') { nw = qty; df = nw - old; } 
                else if (currentMode === 'IN') { nw = old + qty; } 
                else { nw = old - qty; }
                await setDoc(ref, { sku, group, unit, qty: nw, category: cat, usage, model, lastOp: operatorId, time: serverTimestamp() });
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), { sku, type: currentMode, change: qty, after: nw, diff: df, op: operatorId, group, unit, timestamp: serverTimestamp(), comment: comment || "" });
                showToast(`âœ… ${sku} åŒæ­¥æˆåŠŸ`); resetActionFields();
            } catch (e) { showToast("âŒ éŒ¯èª¤"); }
            finally { btn.disabled = false; setMode(currentMode); }
        }

        window.startScanner = async () => {
            document.getElementById('scanner-view').classList.remove('hidden'); html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 25, qrbox: { width: 280, height: 120 }, aspectRatio: 1.777778, videoConstraints: { facingMode: { ideal: "environment" }, width: { ideal: 1280 } } };
            await html5QrCode.start({ facingMode: "environment" }, config, (t) => { document.getElementById('input-sku').value = t; document.getElementById('btn-clear-sku').classList.add('show'); window.onSkuTyping(t); stopScanner(); }).catch(() => stopScanner());
        };
        window.stopScanner = () => { if(html5QrCode) html5QrCode.stop().then(() => document.getElementById('scanner-view').classList.add('hidden')).catch(() => document.getElementById('scanner-view').classList.add('hidden')); else document.getElementById('scanner-view').classList.add('hidden'); };
        
        window.resetActionFields = () => {
            document.getElementById('input-sku').value = ""; document.getElementById('input-model').value = ""; document.getElementById('input-unit').value = ""; document.getElementById('input-usage').value = ""; document.getElementById('input-qty').value = "1";
            document.getElementById('input-group').selectedIndex = 0; document.getElementById('input-category').selectedIndex = 0;
            document.getElementById('btn-clear-sku').classList.remove('show'); document.getElementById('sku-suggestions').classList.add('hidden');
        };

        window.resetStockFilters = () => {
            document.getElementById('filter-group').selectedIndex = 0; updateUnitDropdown(); 
            document.getElementById('filter-unit').selectedIndex = 0; updateCategoryDropdown();
            document.getElementById('filter-category').selectedIndex = 0; document.getElementById('filter-usage').value = "";
            document.getElementById('btn-clear-search').classList.remove('show'); applyFilters();
        };

        function refreshInitialFilters() {
            const data = window.cachedStock || []; const gSet = new Set();
            data.forEach(i => (i.group||"").split(",").forEach(s => gSet.add(s.trim())));
            document.getElementById('filter-group').innerHTML = '<option value="">æ‰€æœ‰æ©Ÿç¾¤</option>' + Array.from(gSet).filter(Boolean).sort().map(g => `<option value="${g}">${g}</option>`).join('');
            const cats = Array.from(new Set(data.map(i => i.category).filter(Boolean))).sort();
            document.getElementById('filter-category').innerHTML = '<option value="">æ‰€æœ‰é¡åˆ¥</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
            updateUnitDropdown(); updateCategoryDropdown();
        }

        window.onFilterGroupChange = () => { document.getElementById('filter-unit').value = ""; document.getElementById('filter-category').value = ""; updateUnitDropdown(); updateCategoryDropdown(); applyFilters(); };
        window.onFilterUnitChange = () => { document.getElementById('filter-category').value = ""; updateCategoryDropdown(); applyFilters(); };
        function updateUnitDropdown() {
            const data = window.cachedStock || []; const selG = document.getElementById('filter-group').value; const uSel = document.getElementById('filter-unit'); const uSet = new Set();
            data.forEach(i => { const gL = (i.group || "").split(",").map(s => s.trim()); const uL = (i.unit || "").split(",").map(s => s.trim()); if (!selG) uL.forEach(u => uSet.add(u)); else uL.forEach((u, idx) => { if (gL[idx] === selG || (gL.length === 1 && gL[0] === selG)) uSet.add(u); }); });
            uSel.innerHTML = '<option value="">æ‰€æœ‰ Unit</option>' + Array.from(uSet).filter(Boolean).sort().map(u => `<option value="${u}">${u}</option>`).join('');
        }
        function updateCategoryDropdown() {
            const data = window.cachedStock || []; const selG = document.getElementById('filter-group').value; const selU = document.getElementById('filter-unit').value; const cSel = document.getElementById('filter-category'); const cSet = new Set();
            data.forEach(i => { const gL = (i.group || "").split(",").map(s => s.trim()); const uL = (i.unit || "").split(",").map(s => s.trim()); if (!selG && !selU) { if(i.category) cSet.add(i.category); } else { let match = false; uL.forEach((u, idx) => { if ((!selG || (gL[idx]||gL[0]) === selG) && (!selU || u === selU)) match = true; }); if (match && i.category) cSet.add(i.category); } });
            cSel.innerHTML = '<option value="">æ‰€æœ‰é¡åˆ¥</option>' + Array.from(cSet).filter(Boolean).sort().map(c => `<option value="${c}">${c}</option>`).join('');
        }
        window.applyFilters = () => { const gF = document.getElementById('filter-group').value; const uF = document.getElementById('filter-unit').value; const cF = document.getElementById('filter-category').value; const search = document.getElementById('filter-usage').value.trim().toLowerCase(); let filtered = window.cachedStock || []; if (gF) filtered = filtered.filter(i => (i.group || "").includes(gF)); if (uF) filtered = filtered.filter(i => (i.unit || "").includes(uF)); if (cF) filtered = filtered.filter(i => i.category === cF); if (search) filtered = filtered.filter(i => (i.usage||'').toLowerCase().includes(search) || (i.sku||'').toLowerCase().includes(search) || (i.model||'').toLowerCase().includes(search) || (i.category||'').toLowerCase().includes(search)); renderStock(filtered); };

        function renderStock(data) {
            const list = document.getElementById('stock-list'); if (!data.length) return list.innerHTML = '<div class="py-20 text-slate-300 text-xs text-center italic uppercase">ç„¡åŒ¹é…æ•¸æ“š</div>';
            list.innerHTML = data.map(i => {
                const gL = (i.group||"").split(",").map(s=>s.trim()); const uL = (i.unit||"").split(",").map(s=>s.trim());
                const b = uL.map((u,idx) => `<span class="unit-badge">${(gL[idx]||gL[0])}_${u}</span>`).join('');
                return `<div class="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm active:bg-slate-50 transition-all text-left" onclick="autoFillStock('${i.sku}')"><div class="flex-1 pr-2 text-left"><div class="mb-1 flex flex-wrap gap-1 text-left">${b}</div><div class="text-[10px] font-black text-blue-600 font-mono mb-0.5 uppercase tracking-tight">${i.model||'ç„¡å‹è™Ÿç´€éŒ„'}</div><div class="font-black text-slate-800 text-sm font-mono leading-none break-all">${i.sku}</div><div class="text-[11px] text-slate-500 mt-2 font-black tracking-tight"><span class="text-slate-400 font-bold uppercase mr-1">${i.category}</span> | ä½ï¼š${i.usage||'æœªè¨»æ˜'}</div></div><div class="flex items-center gap-3"><div class="text-xl font-black ${i.qty < 0 ? 'text-red-500' : 'text-slate-800'} font-mono">${i.qty}</div>${adminModeActive ? `<button onclick="event.stopPropagation(); deleteStockItem('${i.sku}')" class="p-2 bg-red-50 text-red-500 rounded-lg active:scale-90"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>` : ''}</div></div>`;
            }).join('');
        }
        function renderHistory(logs) {
            const list = document.getElementById('history-list'); if (!logs.length) return list.innerHTML = '<div class="py-20 text-slate-300 text-xs text-center italic uppercase">ç„¡æ­·å²ç´€éŒ„</div>';
            list.innerHTML = logs.map(l => {
                const tC = l.type === 'IN' ? 'text-blue-500' : (l.type === 'OUT' ? 'text-orange-500' : 'text-emerald-500');
                let qD = `${l.type} ${l.change}`;
                if (l.type === 'COUNT' && l.diff !== undefined) {
                    const dS = l.diff > 0 ? '+' : ''; const dC = l.diff > 0 ? 'text-blue-600' : (l.diff < 0 ? 'text-red-600' : 'text-slate-400');
                    qD = `ç›¤é»: ${l.after} <span class="${dC}">(å·®å€¼: ${dS}${l.diff})</span>`;
                }
                return `<div class="bg-white p-4 rounded-2xl border border-slate-50 shadow-sm text-[10px] space-y-1 relative text-left"><div class="flex justify-between items-start"><div class="font-black text-slate-800 font-mono text-sm">${l.sku}</div><div class="flex items-center gap-3"><div class="font-black ${tC} text-right uppercase">${qD}</div>${adminModeActive ? `<button onclick="deleteHistoryItem('${l.id}', ${JSON.stringify(l).replace(/"/g, '&quot;')})" class="p-1.5 bg-red-50 text-red-500 rounded-lg active:scale-90"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>` : ''}</div></div><div class="text-slate-400 font-medium">å·¥è™Ÿ: ${l.op} â€¢ ${l.timestamp ? new Date(l.timestamp.toMillis()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...'}</div><div class="text-slate-500 font-mono">${l.group||''}_${l.unit||''}</div>${l.comment ? `<div class="mt-2 bg-blue-50/50 text-blue-600 p-2 rounded-lg italic font-bold">å‚™è¨»: ${l.comment}</div>` : ''}</div>`;
            }).join('');
        }

        window.clearSkuInput = () => { const input = document.getElementById('input-sku'); input.value = ""; document.getElementById('btn-clear-sku').classList.remove('show'); document.getElementById('sku-suggestions').classList.add('hidden'); input.focus(); };
        window.clearSearchInput = () => { const input = document.getElementById('filter-usage'); input.value = ""; document.getElementById('btn-clear-search').classList.remove('show'); applyFilters(); input.focus(); };
        window.toggleSearchClearBtn = (val) => { document.getElementById('btn-clear-search').classList.toggle('show', val.length > 0); };
        window.onSkuTyping = (v) => { document.getElementById('btn-clear-sku').classList.toggle('show', v.length > 0); const c = document.getElementById('sku-suggestions'); if (!v || !window.cachedStock) { c.classList.add('hidden'); return; } const m = window.cachedStock.filter(i => i.sku.toLowerCase().includes(v.toLowerCase())).slice(0, 8); if (m.length > 0) { c.innerHTML = m.map(i => `<div class="suggestion-item text-left"><div class="font-bold text-xs font-mono text-left">${i.sku}</div><div class="text-[8px] text-slate-400 font-mono text-left">å‹è™Ÿï¼š${i.model||'ç„¡'} | æ•¸é‡ï¼š${i.qty}</div></div>`).join(''); c.classList.remove('hidden'); } else c.classList.add('hidden'); };
        window.autoFillStock = (sku) => { const item = window.cachedStock.find(i => i.sku === sku); if (!item) return; const uL = (item.unit || "").split(",").map(u => u.trim()).filter(Boolean); const gL = (item.group || "").split(",").map(g => g.trim()).filter(Boolean); const usL = (item.usage || "").split(",").map(u => u.trim()).filter(Boolean); if (Math.max(uL.length, gL.length, usL.length) > 1) showContextPicker(item, gL, uL, usL, false); else applyContext(item.sku, gL[0]||"", uL[0]||"", item.category, usL[0]||"", item.model||""); };
        function applyContext(sku, g, u, cat, usage, model) { document.getElementById('input-sku').value = sku; document.getElementById('btn-clear-sku').classList.add('show'); document.getElementById('input-model').value = model; document.getElementById('input-group').value = g || ""; document.getElementById('input-unit').value = u; document.getElementById('input-category').value = cat || ""; document.getElementById('input-usage').value = usage; switchTab('action'); showToast(`å·²å¸¶å…¥ç‰ˆæœ¬ï¼š${g}_${u}`); }
        function showContextPicker(item, groups, units, usages, isDeleteMode = false) { activePickerSku = item.sku; const list = document.getElementById('context-options-list'); list.innerHTML = ""; document.getElementById('picker-title').innerText = isDeleteMode ? "é¸æ“‡è¦ç§»é™¤çš„ç’°å¢ƒ" : "æ©Ÿå°ç”¨é€”é¸å–"; document.getElementById('admin-full-delete-zone').classList.toggle('hidden', !isDeleteMode); for (let i = 0; i < Math.max(groups.length, units.length, usages.length); i++) { const g = groups[i] || groups[0] || ""; const u = units[i] || units[0] || ""; const us = usages[i] || ""; const btn = document.createElement('button'); btn.className = `w-full p-4 border rounded-2xl text-left mb-2 active:scale-95 transition-transform ${isDeleteMode?'bg-red-50 border-red-100':'bg-slate-50 border-slate-200'}`; btn.innerHTML = `<div class="flex justify-between items-center text-[10px]"><div><span class="font-black ${isDeleteMode?'text-red-600':'text-blue-600'} uppercase font-mono tracking-tight">${g}_${u}</span><div class="text-slate-800 font-black mt-1.5 text-xs text-left">ä½ï¼š${us || 'æœªè¨»æ˜'}</div></div><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="${isDeleteMode?'M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2':'M5 12h14M12 5l7 7-7 7'}"/></svg></div>`; btn.onclick = () => isDeleteMode ? executePartialDelete(item.sku, i) : (applyContext(item.sku, g, u, item.category, us, item.model||""), closeContextPicker()); list.appendChild(btn); } document.getElementById('context-picker-modal').classList.remove('hidden'); }
        async function executePartialDelete(sku, idx) { const item = window.cachedStock.find(i => i.sku === sku); const g = item.group.split(",").map(s => s.trim()); const u = item.unit.split(",").map(s => s.trim()); const us = (item.usage||"").split(",").map(s => s.trim()); g.splice(idx, 1); u.splice(idx, 1); if (us[idx] !== undefined) us.splice(idx, 1); await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku), { ...item, group: g.join(", "), unit: u.join(", "), usage: us.join(", "), lastOp: operatorId }); showToast("å·²ç§»é™¤ç’°å¢ƒé—œè¯"); closeContextPicker(); }
        window.executeFullDeleteFromPicker = () => { if(confirm(`å¾¹åº•åˆªé™¤æ•´å€‹æ–™è™Ÿ ${activePickerSku}ï¼Ÿ`)) { deleteStockItem(activePickerSku); closeContextPicker(); } };
        async function deleteStockItem(sku) { if(confirm(`å¾¹åº•åˆªé™¤æ–™è™Ÿ ${sku}ï¼Ÿ`)) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku)); showToast(`ğŸ—‘ï¸ å·²å¾¹åº•åˆªé™¤ ${sku}`); } }
        window.processPastedText = async () => { const text = document.getElementById('import-text-area').value.trim(); if (!text) return; showToast("â³ åŸ·è¡Œæ™ºæ…§åˆä½µ..."); const rows = text.split(/\r?\n/).filter(r => r.trim() !== ""); const batch = writeBatch(db); const inMap = new Map(); try { let start = (rows[0].includes("æ©Ÿç¾¤") || rows[0].includes("æ–™è™Ÿ")) ? 1 : 0; for (let i = start; i < rows.length; i++) { const c = rows[i].split(",").map(s => s.trim().replace(/^"|"$/g, "")); if (c.length < 5) continue; const [g, u, cat, us, sku, qtyS, model] = c; const qty = parseInt(qtyS) || 0; if (!inMap.has(sku)) inMap.set(sku, { gS: new Set([g]), uS: new Set([u]), usS: new Set([us]), cat, qty, model: model || "" }); else { const m = inMap.get(sku); m.gS.add(g); m.uS.add(u); m.usS.add(us); m.qty = qty; if(model) m.model = model; } } for (const [sku, input] of inMap) { const cloud = window.cachedStock.find(it => it.sku === sku); let fG, fU, fUs; if (cloud) { const gS = new Set(cloud.group.split(",").map(s => s.trim())); const uS = new Set(cloud.unit.split(",").map(s => s.trim())); const usS = new Set((cloud.usage || "").split(",").map(s => s.trim())); input.gS.forEach(v => gS.add(v)); input.uS.forEach(v => uS.add(v)); input.usS.forEach(v => usS.add(v)); fG = Array.from(gS).filter(Boolean).join(", "); fU = Array.from(uS).filter(Boolean).join(", "); fUs = Array.from(usS).filter(Boolean).join(", "); } else { fG = Array.from(input.gS).join(", "); fU = Array.from(input.uS).join(", "); fUs = Array.from(input.usS).join(", "); } batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku), { sku, group: fG, unit: fU, category: input.cat || "å…¶ä»–", usage: fUs, qty: input.qty, model: input.model, lastOp: operatorId, time: serverTimestamp() }); } await batch.commit(); showToast(`âœ… æ™ºæ…§åˆä½µæˆåŠŸ`); closeImportModal(); } catch (e) { showToast("âŒ è§£æå¤±æ•—"); } };
        window.applySuggestion = (sku) => { autoFillStock(sku); document.getElementById('sku-suggestions').classList.add('hidden'); };
        window.openImportModal = () => document.getElementById('import-modal').classList.remove('hidden');
        window.closeImportModal = () => document.getElementById('import-modal').classList.add('hidden');
        window.closeContextPicker = () => document.getElementById('context-picker-modal').classList.add('hidden');
        window.showConfirmModal = (title, msg, actions) => { document.getElementById('confirm-title').innerText = title; document.getElementById('confirm-modal-msg').innerHTML = msg; const container = document.getElementById('confirm-standard-actions'); container.innerHTML = ""; actions.forEach(a => { const btn = document.createElement('button'); btn.className = `w-full py-3 rounded-xl font-bold text-xs ${a.color} ${a.textColor || 'text-white'}`; btn.innerText = a.text; btn.onclick = a.action; container.appendChild(btn); }); document.getElementById('confirm-modal').classList.remove('hidden'); };
        window.closeConfirmModal = () => document.getElementById('confirm-modal').classList.add('hidden');
        window.toggleSettingsManager = (s) => document.getElementById('settings-modal').classList.toggle('hidden', !s);
        window.addNewCategory = async () => { const i = document.getElementById('new-category-name'); if (!i.value.trim()) return; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), { list: [...categories, i.value.trim()] }); i.value = ""; };
        window.removeCategory = async (n) => { if (confirm(`ç§»é™¤é¡åˆ¥ ${n}ï¼Ÿ`)) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), { list: categories.filter(x => x !== n) }); };
        window.addNewGroup = async () => { const i = document.getElementById('new-group-name'); if (!i.value.trim()) return; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', 'all'), { list: [...machineGroups, i.value.trim()] }); i.value = ""; };
        window.removeGroup = async (n) => { if (confirm(`ç§»é™¤æ©Ÿç¾¤ ${n}ï¼Ÿ`)) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', 'all'), { list: machineGroups.filter(x => x !== n) }); };
        window.setMode = (m) => { currentMode = m; ['IN','OUT','COUNT'].forEach(x => document.getElementById(`mode-${x.toLowerCase()}`).className = x === m ? 'flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold text-xs shadow-md' : 'flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs'); const btn = document.getElementById('btn-submit'); btn.innerText = m==='IN'?'ç¢ºèªå…¥åº«':(m==='OUT'?'ç¢ºèªå‡ºåº«':'ä¿®æ­£ç›¤é»'); btn.style.backgroundColor = m==='IN'?'#2563eb':(m==='OUT'?'#f97316':'#10b981'); };
        window.switchTab = (t) => { ['action','stock','history'].forEach(x => { document.getElementById(`section-${x}`).classList.toggle('hidden', x !== t); document.getElementById(`tab-${x}`).classList.toggle('tab-active', x === t); }); };
        window.stepQty = (v) => { const i = document.getElementById('input-qty'); i.value = Math.max(0, (parseInt(i.value) || 0) + v); };
        function showToast(m) { const t = document.getElementById('toast'); t.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>${m}`; t.style.opacity = "1"; setTimeout(() => t.style.opacity = "0", 2500); }
        document.addEventListener('click', (e) => { if (e.target.id !== 'input-sku') document.getElementById('sku-suggestions').classList.add('hidden'); });
        init();
    </script>
</body>
</html>

