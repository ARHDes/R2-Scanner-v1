<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤šäººé›²ç«¯å€‰åº«åŠ©æ‰‹ V11.0</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 800; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .suggestion-item { padding: 10px 14px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .suggestion-item:active { background: #eff6ff; }
        .admin-glow { box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); border: 1px solid rgba(245, 158, 11, 0.5); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .unit-badge { display: inline-block; background: #f1f5f9; color: #64748b; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 4px; font-weight: bold; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 font-sans text-slate-900">

    <!-- å·¥è™Ÿç™»éŒ„ -->
    <div id="setup-overlay" class="fixed inset-0 bg-blue-600 z-[1000] flex items-center justify-center p-6 hidden">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl text-center">
            <h2 class="text-2xl font-black mb-2 text-slate-800">å·¥è™Ÿç™»éŒ„</h2>
            <p class="text-slate-500 text-sm mb-6">è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿä»¥é–‹å§‹ä½œæ¥­ã€‚</p>
            <input type="text" id="operator-name-input" placeholder="è«‹è¼¸å…¥å·¥è™Ÿ" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 mb-4 outline-none focus:border-blue-500 text-center font-bold text-lg">
            <button onclick="saveOperatorName()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-all">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <!-- å°èˆªæ¬„ -->
    <nav id="top-nav" class="bg-white border-b border-slate-200 px-4 py-3 sticky top-0 z-50 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-2 text-left">
            <div class="flex flex-col">
                <span id="admin-badge" class="hidden text-[8px] font-black bg-amber-500 text-white px-1.5 py-0.5 rounded-full w-fit mb-0.5 uppercase tracking-tighter">ç®¡ç†å“¡æ¨¡å¼</span>
                <span id="display-operator" class="text-sm font-bold text-slate-700">è¼‰å…¥ä¸­...</span>
            </div>
        </div>
        <div class="flex items-center gap-1.5">
            <button id="admin-toggle-btn" onclick="toggleAdminMode()" class="hidden p-2 bg-amber-50 text-amber-600 rounded-lg border border-amber-100"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg></button>
            <button onclick="toggleSettingsManager(true)" class="p-2 bg-slate-100 rounded-lg text-slate-600"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></button>
            <button onclick="logout()" class="p-2 bg-red-50 text-red-500 rounded-lg border border-red-100"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg></button>
        </div>
    </nav>

    <main class="max-w-md mx-auto p-4 space-y-4">
        <div class="flex bg-white rounded-xl p-1 shadow-sm border border-slate-100">
            <button onclick="switchTab('action')" id="tab-action" class="flex-1 py-2 text-sm font-bold tab-active">æ“ä½œ</button>
            <button onclick="switchTab('stock')" id="tab-stock" class="flex-1 py-2 text-sm font-bold text-slate-400">ç¾å­˜åº«å­˜</button>
            <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-2 text-sm font-bold text-slate-400">æ­·å²ç´€éŒ„</button>
        </div>

        <!-- A. æ“ä½œé é¢ -->
        <div id="section-action" class="space-y-4">
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 space-y-4">
                <div class="flex gap-2 p-1 bg-slate-50 rounded-xl">
                    <button onclick="setMode('IN')" id="mode-in" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold text-xs">å…¥åº«</button>
                    <button onclick="setMode('OUT')" id="mode-out" class="flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs">å‡ºåº«</button>
                    <button onclick="setMode('COUNT')" id="mode-count" class="flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs">ç›¤é»</button>
                </div>
                
                <div class="space-y-3 relative">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">æ©Ÿç¾¤</label>
                            <select id="input-group" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold text-slate-800 outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Unitåç¨±</label>
                            <input type="text" id="input-unit" placeholder="ä¾‹å¦‚ï¼šScribe1" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">é¡åˆ¥</label>
                            <select id="input-category" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold text-slate-800 outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">ä½ç½® / ç”¨é€”</label>
                            <input type="text" id="input-usage" placeholder="å‚™è¨»..." class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">æ–™è™Ÿ / æ¢ç¢¼</label>
                        <div class="flex gap-2">
                            <input type="text" id="input-sku" oninput="onSkuTyping(this.value)" placeholder="æœå°‹æ–™è™Ÿ..." class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 font-mono" autocomplete="off">
                            <button onclick="startScanner()" class="bg-blue-100 text-blue-600 p-3 rounded-xl active:scale-90 transition-transform"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"></path></svg></button>
                        </div>
                        <div id="sku-suggestions" class="absolute left-0 right-0 bg-white border border-slate-200 rounded-xl shadow-xl z-50 mt-1 hidden max-h-60 overflow-y-auto hide-scroll"></div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">ç•°å‹•æ•¸é‡</label>
                        <div class="flex items-center bg-slate-50 rounded-xl p-1">
                            <button onclick="stepQty(-1)" class="w-12 h-10 bg-white rounded-lg shadow-sm font-bold text-xl active:bg-slate-100">-</button>
                            <input type="number" id="input-qty" value="1" class="flex-1 bg-transparent text-center font-black text-xl outline-none">
                            <button onclick="stepQty(1)" class="w-12 h-10 bg-white rounded-lg shadow-sm font-bold text-xl active:bg-slate-100">+</button>
                        </div>
                    </div>

                    <button id="btn-submit" onclick="submitTransaction()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-xl shadow-blue-100 active:scale-95 transition-all">ç¢ºèªæäº¤</button>
                </div>
            </div>
        </div>

        <!-- B. åº«å­˜åˆ†é  (æ™ºæ…§ç¯©é¸) -->
        <div id="section-stock" class="hidden space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 space-y-3">
                <div class="flex justify-between items-center px-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">å¤šç¶­åº¦ç¯©é¸ (å«å…±ç”¨ä»¶)</span>
                    <button onclick="openImportModal()" class="text-blue-600 text-[10px] font-bold border-b border-blue-200">æ–‡å­—åŒ¯å…¥</button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <select id="filter-group" onchange="applyFilters()" class="bg-slate-50 border-0 rounded-lg px-3 py-2 text-xs font-bold outline-none focus:ring-1 focus:ring-blue-500"><option value="">æ‰€æœ‰æ©Ÿç¾¤</option></select>
                    <select id="filter-unit" onchange="applyFilters()" class="bg-slate-50 border-0 rounded-lg px-3 py-2 text-xs font-bold outline-none focus:ring-1 focus:ring-blue-500"><option value="">æ‰€æœ‰ Unit</option></select>
                </div>
            </div>
            <div id="stock-list" class="space-y-2"></div>
        </div>

        <!-- C. æ­·å²åˆ†é  -->
        <div id="section-history" class="hidden space-y-3"><div id="history-list" class="space-y-2"></div></div>
    </main>

    <!-- å½ˆçª—ç¾¤ -->
    <div id="import-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[2000] hidden flex items-center justify-center p-6" onclick="closeImportModal()">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 space-y-4 shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-xl font-black">æ–‡å­—åŒ¯å…¥</h3>
            <p class="text-[10px] text-slate-500">æ ¼å¼ï¼šæ©Ÿç¾¤,Unit,é¡åˆ¥,ä½ç½®/ç”¨é€”,æ–™è™Ÿ,æ•¸é‡</p>
            <textarea id="import-text-area" placeholder="CSCR,Scribe1,CYLINDER,CST_Clamp,R27310144KB0,0" class="w-full h-48 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl p-3 text-xs font-mono outline-none"></textarea>
            <div class="flex gap-3"><button onclick="closeImportModal()" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-xs text-slate-500">å–æ¶ˆ</button><button onclick="processPastedText()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-xs shadow-lg">é–‹å§‹åŒ¯å…¥</button></div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-6" onclick="toggleSettingsManager(false)">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 space-y-6 shadow-2xl" onclick="event.stopPropagation()">
            <div class="space-y-3">
                <h3 class="text-sm font-black text-slate-800 border-l-4 border-blue-500 pl-2">é¡åˆ¥ç®¡ç†</h3>
                <div id="admin-cat-controls" class="hidden flex gap-2"><input type="text" id="new-category-name" placeholder="æ–°é¡åˆ¥..." class="flex-1 bg-slate-50 rounded-xl px-3 py-2 text-sm outline-none"><button onclick="addNewCategory()" class="bg-blue-600 text-white px-4 rounded-xl font-bold">+</button></div>
                <div id="category-list-manager" class="space-y-2 max-h-32 overflow-y-auto pr-1 hide-scroll"></div>
            </div>
            <div class="space-y-3">
                <h3 class="text-sm font-black text-slate-800 border-l-4 border-amber-500 pl-2">æ©Ÿç¾¤ç®¡ç†</h3>
                <div id="admin-group-controls" class="hidden flex gap-2"><input type="text" id="new-group-name" placeholder="æ–°æ©Ÿç¾¤..." class="flex-1 bg-slate-50 rounded-xl px-3 py-2 text-sm outline-none"><button onclick="addNewGroup()" class="bg-amber-500 text-white px-4 rounded-xl font-bold">+</button></div>
                <div id="group-list-manager" class="space-y-2 max-h-32 overflow-y-auto pr-1 hide-scroll"></div>
            </div>
            <button onclick="toggleSettingsManager(false)" class="w-full py-3 bg-slate-100 rounded-xl font-bold text-slate-500 text-sm">é—œé–‰</button>
        </div>
    </div>

    <!-- å…±ç”¨ä»¶è™•ç†å½ˆçª— -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[4000] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 space-y-4 shadow-2xl text-center">
            <div id="confirm-icon" class="w-14 h-14 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-2"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10zM12 8v4M12 16h.01"/></svg></div>
            <h3 id="confirm-title" class="text-lg font-black">æ–™è™Ÿå·²å­˜åœ¨</h3>
            <p id="confirm-modal-msg" class="text-xs text-slate-500 leading-relaxed"></p>
            <div class="flex flex-col gap-2 pt-2">
                <button onclick="handleConflictResponse('MERGE')" class="w-full py-3 bg-blue-600 rounded-xl font-bold text-white text-xs shadow-lg shadow-blue-100">è¨­ç‚ºå…±ç”¨ä»¶ (ä¿ç•™å…©è€…å–®ä½)</button>
                <button onclick="handleConflictResponse('OVERWRITE')" class="w-full py-3 bg-amber-500 rounded-xl font-bold text-white text-xs">å¼·åˆ¶è¦†è“‹ (æ”¹ç‚ºç›®å‰å–®ä½)</button>
                <button onclick="handleConflictResponse('CANCEL')" class="w-full py-3 bg-slate-100 rounded-xl font-bold text-slate-500 text-xs">å–æ¶ˆæ“ä½œ</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur text-white px-6 py-3 rounded-full text-[10px] font-bold opacity-0 transition-all z-[5000] pointer-events-none shadow-2xl"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, serverTimestamp, getDoc, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDlrIJR7wKN_lzcTiC2ohe8jeXaC3mZXdk", authDomain: "storage-3098e.firebaseapp.com", projectId: "storage-3098e", storageBucket: "storage-3098e.firebasestorage.app", messagingSenderId: "947569272384", appId: "1:947569272384:web:badb6b78e91e36cee5a1a5", measurementId: "G-1WEQXLGR20" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'storage-3098e'; 
        const ADMIN_ID = '22009866';

        let operatorId = localStorage.getItem('ims_op_v11'); 
        let currentMode = 'IN';
        let adminModeActive = false;
        let categories = [];
        let machineGroups = [];
        let html5QrCode = null;
        let pendingTransaction = null;

        async function init() {
            if (!operatorId) document.getElementById('setup-overlay').classList.remove('hidden');
            else { document.getElementById('display-operator').innerText = `ğŸ‘¤ å·¥è™Ÿ: ${operatorId}`; checkAdminStatus(); }
            try { await signInAnonymously(auth); onAuthStateChanged(auth, (u) => { if (u) loadCloudData(); }); } catch (err) { console.error(err); }
        }

        function checkAdminStatus() {
            if (operatorId === ADMIN_ID) {
                ['admin-toggle-btn','admin-cat-controls','admin-group-controls'].forEach(id => document.getElementById(id).classList.remove('hidden'));
                document.getElementById('display-operator').classList.add('text-amber-600');
            }
        }

        window.saveOperatorName = () => {
            const id = document.getElementById('operator-name-input').value.trim();
            if (!id) return;
            localStorage.setItem('ims_op_v11', id);
            location.reload();
        };

        window.logout = () => { if (confirm("ç¢ºå®šè¦ç™»å‡ºå·¥è™Ÿå—ï¼Ÿ")) { localStorage.removeItem('ims_op_v11'); location.reload(); } };

        window.toggleAdminMode = () => {
            adminModeActive = !adminModeActive;
            const nav = document.getElementById('top-nav');
            nav.classList.toggle('admin-glow', adminModeActive);
            nav.classList.toggle('bg-amber-50', adminModeActive);
            document.getElementById('admin-badge').classList.toggle('hidden', !adminModeActive);
            renderStock(window.cachedStock || []);
            renderCats();
            renderGroups();
        };

        function loadCloudData() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), (s) => {
                categories = s.exists() ? s.data().list : ['åŸ¹æ—', 'æ°£å£“ç¼¸', 'èºçµ²', 'è€—æ'];
                renderCats();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'groups', 'all'), (s) => {
                machineGroups = s.exists() ? s.data().list : ['CSCR', 'CST', 'CV'];
                renderGroups();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'stock'), (s) => {
                const data = s.docs.map(d => d.data());
                window.cachedStock = data;
                updateFilterOptions(data);
                applyFilters();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'history'), (s) => {
                const logs = s.docs.map(d => d.data()).sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderHistory(logs);
            });
        }

        // --- æ ¸å¿ƒå…±ç”¨ä»¶è™•ç†é‚è¼¯ ---
        window.submitTransaction = async () => {
            const sku = document.getElementById('input-sku').value.trim();
            const group = document.getElementById('input-group').value;
            const unit = document.getElementById('input-unit').value.trim();
            const cat = document.getElementById('input-category').value;
            const usage = document.getElementById('input-usage').value.trim();
            const qty = parseInt(document.getElementById('input-qty').value) || 0;

            if (!sku || !group || !unit || qty < 0) return showToast("âš ï¸ è«‹å¡«å¯«å®Œæ•´è³‡æ–™");

            const existing = window.cachedStock.find(i => i.sku === sku);
            if (existing) {
                const units = (existing.unit || "").split(",").map(u => u.trim());
                const groups = (existing.group || "").split(",").map(g => g.trim());
                
                // å¦‚æœå–®ä½æˆ–æ©Ÿç¾¤ä¸åŒï¼Œå•Ÿå‹•å…±ç”¨ä»¶è©¢å•
                if (!groups.includes(group) || !units.includes(unit) || existing.category !== cat) {
                    pendingTransaction = { sku, group, unit, cat, usage, qty, existing };
                    let msg = `æ–™è™Ÿ <b>${sku}</b> å·²å­˜æ–¼ï¼š<br>${existing.group} / ${existing.unit}<br><br>æ‚¨ç¾åœ¨è¼¸å…¥çš„æ˜¯ï¼š<br>${group} / ${unit}<br><br>è«‹å•å¦‚ä½•è™•ç†ï¼Ÿ`;
                    document.getElementById('confirm-modal-msg').innerHTML = msg;
                    document.getElementById('confirm-modal').classList.remove('hidden');
                    return;
                }
            }
            executeCommit(sku, group, unit, cat, usage, qty);
        };

        window.handleConflictResponse = (action) => {
            document.getElementById('confirm-modal').classList.add('hidden');
            if (action === 'CANCEL') return;
            
            let { sku, group, unit, cat, usage, qty, existing } = pendingTransaction;
            
            if (action === 'MERGE') {
                // åˆä½µå–®ä½æ¸…å–® (å»é‡)
                const gSet = new Set((existing.group || "").split(",").map(u => u.trim()));
                const uSet = new Set((existing.unit || "").split(",").map(u => u.trim()));
                const usageSet = new Set((existing.usage || "").split(",").map(u => u.trim()));
                gSet.add(group); uSet.add(unit); if(usage) usageSet.add(usage);
                
                group = Array.from(gSet).join(", ");
                unit = Array.from(uSet).join(", ");
                usage = Array.from(usageSet).join(", ");
            }
            executeCommit(sku, group, unit, cat, usage, qty);
        };

        async function executeCommit(sku, group, unit, cat, usage, qty) {
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            try {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku);
                const snap = await getDoc(ref);
                let oldQty = snap.exists() ? snap.data().qty : 0;
                let newQty = currentMode === 'IN' ? oldQty + qty : (currentMode === 'OUT' ? oldQty - qty : qty);

                await setDoc(ref, { sku, group, unit, qty: newQty, category: cat, usage, lastOp: operatorId, time: serverTimestamp() });
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), {
                    sku, type: currentMode, change: qty, after: newQty, op: operatorId, group, unit, timestamp: serverTimestamp()
                });

                showToast(`âœ… ${sku} å·²åŒæ­¥`);
                document.getElementById('input-sku').value = ""; document.getElementById('input-qty').value = "1";
            } catch (e) { showToast("âŒ æ›´æ–°å¤±æ•—"); }
            finally { btn.disabled = false; setMode(currentMode); }
        }

        // --- ç¯©é¸èˆ‡å»ºè­° ---
        function updateFilterOptions(data) {
            const gSet = new Set(); const uSet = new Set();
            data.forEach(i => {
                (i.group || "").split(",").forEach(s => gSet.add(s.trim()));
                (i.unit || "").split(",").forEach(s => uSet.add(s.trim()));
            });
            const groups = Array.from(gSet).filter(Boolean).sort();
            const units = Array.from(uSet).filter(Boolean).sort();
            
            document.getElementById('filter-group').innerHTML = '<option value="">æ‰€æœ‰æ©Ÿç¾¤</option>' + groups.map(g => `<option value="${g}">${g}</option>`).join('');
            document.getElementById('filter-unit').innerHTML = '<option value="">æ‰€æœ‰ Unit</option>' + units.map(u => `<option value="${u}">${u}</option>`).join('');
        }

        window.applyFilters = () => {
            const g = document.getElementById('filter-group').value;
            const u = document.getElementById('filter-unit').value;
            let filtered = window.cachedStock || [];
            if (g) filtered = filtered.filter(i => (i.group || "").includes(g));
            if (u) filtered = filtered.filter(i => (i.unit || "").includes(u));
            renderStock(filtered);
        };

        window.onSkuTyping = (val) => {
            const container = document.getElementById('sku-suggestions');
            if (!val || !window.cachedStock) { container.classList.add('hidden'); return; }
            const matches = window.cachedStock.filter(i => i.sku.toLowerCase().includes(val.toLowerCase())).slice(0, 8);
            if (matches.length > 0) {
                container.innerHTML = matches.map(i => `
                    <div class="suggestion-item" onclick="applySuggestion('${i.sku}')">
                        <div class="font-bold text-slate-800 text-xs font-mono">${i.sku}</div>
                        <div class="text-[9px] text-slate-400 font-mono">å–®ä½ï¼š${i.unit}</div>
                    </div>`).join('');
                container.classList.remove('hidden');
            } else { container.classList.add('hidden'); }

            const exact = window.cachedStock.find(i => i.sku.toLowerCase() === val.trim().toLowerCase());
            if (exact) applyAutoFields(exact);
        };

        function applyAutoFields(item) {
            // å¦‚æœæ˜¯å…±ç”¨ä»¶(æœ‰å¤šå€‹å–®ä½)ï¼Œé è¨­é¸ç¬¬ä¸€å€‹ï¼Œæˆ–æ˜¯ç•™ç©ºè®“ä½¿ç”¨è€…é¸
            const gList = item.group.split(",");
            document.getElementById('input-group').value = machineGroups.includes(gList[0].trim()) ? gList[0].trim() : "";
            document.getElementById('input-unit').value = item.unit.split(",")[0].trim() || "";
            document.getElementById('input-category').value = item.category || "";
            document.getElementById('input-usage').value = item.usage.split(",")[0].trim() || "";
        }

        window.applySuggestion = (sku) => {
            const item = window.cachedStock.find(i => i.sku === sku);
            if (item) { applyAutoFields(item); document.getElementById('input-sku').value = item.sku; document.getElementById('sku-suggestions').classList.add('hidden'); }
        };

        // --- åŒ¯å…¥èˆ‡ç®¡ç† (V11.0 æ ¼å¼) ---
        window.openImportModal = () => document.getElementById('import-modal').classList.remove('hidden');
        window.closeImportModal = () => document.getElementById('import-modal').classList.add('hidden');
        window.processPastedText = async () => {
            const text = document.getElementById('import-text-area').value.trim();
            if (!text) return;
            showToast("â³ åŒ¯å…¥ä¸­...");
            const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
            const batch = writeBatch(db);
            let count = 0; let newCats = new Set(categories); let newGroups = new Set(machineGroups);
            try {
                let start = (rows[0].includes("æ©Ÿç¾¤") || rows[0].includes("æ–™è™Ÿ")) ? 1 : 0;
                for (let i = start; i < rows.length; i++) {
                    const c = rows[i].split(",").map(s => s.trim().replace(/^"|"$/g, ""));
                    if (c.length < 5) continue;
                    const [group, unit, cat, usage, sku, qtyStr] = c;
                    const qty = parseInt(qtyStr) || 0;
                    if (!sku) continue;
                    batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku), { sku, group, unit, category: cat, usage, qty, lastOp: operatorId + "(åŒ¯å…¥)", time: serverTimestamp() });
                    if (cat) newCats.add(cat); if (group) newGroups.add(group);
                    count++;
                }
                if (newCats.size > categories.length) batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), { list: Array.from(newCats) });
                if (newGroups.size > machineGroups.length) batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'groups', 'all'), { list: Array.from(newGroups) });
                await batch.commit();
                showToast(`âœ… åŒ¯å…¥æˆåŠŸ ${count} ç­†`);
                document.getElementById('import-text-area').value = ""; closeImportModal();
            } catch (e) { showToast("âŒ è§£æå¤±æ•—"); }
        };

        window.addNewCategory = async () => { const i = document.getElementById('new-category-name'); if (!i.value.trim()) return; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), { list: [...categories, i.value.trim()] }); i.value = ""; };
        window.removeCategory = async (n) => { if (confirm(`ç§»é™¤é¡åˆ¥ã€Œ${n}ã€ï¼Ÿ`)) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), { list: categories.filter(x => x !== n) }); };
        window.addNewGroup = async () => { const i = document.getElementById('new-group-name'); if (!i.value.trim()) return; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', 'all'), { list: [...machineGroups, i.value.trim()] }); i.value = ""; };
        window.removeGroup = async (n) => { if (confirm(`ç§»é™¤æ©Ÿç¾¤ã€Œ${n}ã€ï¼Ÿ`)) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', 'all'), { list: machineGroups.filter(x => x !== n) }); };
        window.deleteStockItem = (sku) => { if(confirm(`æ°¸ä¹…åˆªé™¤ ${sku}ï¼Ÿ`)) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku)); };

        // --- UI å·¥å…· ---
        function renderCats() { document.getElementById('input-category').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join(''); document.getElementById('category-list-manager').innerHTML = categories.map(c => `<div class="flex justify-between items-center bg-slate-50 p-2 rounded-xl border border-slate-100"><span class="font-bold text-[11px] text-slate-700">${c}</span>${adminModeActive ? `<button onclick="removeCategory('${c}')" class="text-red-500 font-bold text-[9px]">ç§»é™¤</button>` : ''}</div>`).join(''); }
        function renderGroups() { document.getElementById('input-group').innerHTML = '<option value="" disabled selected>é¸æ“‡æ©Ÿç¾¤</option>' + machineGroups.map(g => `<option value="${g}">${g}</option>`).join(''); document.getElementById('group-list-manager').innerHTML = machineGroups.map(g => `<div class="flex justify-between items-center bg-slate-50 p-2 rounded-xl border border-slate-100"><span class="font-bold text-[11px] text-slate-700 font-mono">${g}</span>${adminModeActive ? `<button onclick="removeGroup('${g}')" class="text-red-500 font-bold text-[9px]">ç§»é™¤</button>` : ''}</div>`).join(''); }
        function renderStock(data) {
            const list = document.getElementById('stock-list');
            if (!data.length) return list.innerHTML = '<div class="text-center py-20 text-slate-300 text-xs italic">ç„¡åŒ¹é…è³‡æ–™</div>';
            list.innerHTML = data.map(i => `
                <div class="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm" onclick="applySuggestion('${i.sku}'); switchTab('action');">
                    <div class="flex-1 pr-2 text-left">
                        <div class="mb-1 flex flex-wrap gap-1">
                            ${(i.unit || "").split(",").map(u => `<span class="unit-badge">${u.trim()}</span>`).join('')}
                        </div>
                        <div class="font-black text-slate-800 text-sm break-all font-mono leading-none">${i.sku}</div>
                        <div class="text-[8px] text-slate-400 mt-1 uppercase font-medium">${i.category} | ä½ï¼š${i.usage||'æœªè¨»æ˜'}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-xl font-black ${i.qty < 0 ? 'text-red-500' : 'text-slate-800'}">${i.qty}</div>
                        ${adminModeActive ? `<button onclick="event.stopPropagation(); deleteStockItem('${i.sku}')" class="p-2 bg-red-50 text-red-500 rounded-lg active:scale-90"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>` : ''}
                    </div>
                </div>`).join('');
        }
        function renderHistory(logs) {
            const list = document.getElementById('history-list');
            list.innerHTML = logs.slice(0, 20).map(l => `
                <div class="bg-white p-3 rounded-xl border border-slate-50 flex justify-between items-center text-[9px] shadow-sm">
                    <div class="text-left font-mono"><div class="font-bold text-slate-800">${l.sku}</div><div class="text-slate-400">å·¥è™Ÿ: ${l.op} â€¢ ${l.timestamp ? new Date(l.timestamp.toMillis()).toLocaleTimeString() : '...'}</div></div>
                    <div class="font-black ${l.type==='IN'?'text-blue-500':(l.type==='OUT'?'text-orange-500':'text-emerald-500')}">${l.type} ${l.change}</div>
                </div>`).join('');
        }
        window.setMode = (m) => { currentMode = m; ['IN','OUT','COUNT'].forEach(x => document.getElementById(`mode-${x.toLowerCase()}`).className = x === m ? 'flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold text-xs shadow-md' : 'flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs'); document.getElementById('btn-submit').innerText = m==='IN'?'ç¢ºèªå…¥åº«':(m==='OUT'?'ç¢ºèªå‡ºåº«':'ä¿®æ­£å­˜é‡'); document.getElementById('btn-submit').style.backgroundColor = m==='IN'?'#2563eb':(m==='OUT'?'#f97316':'#10b981'); };
        window.switchTab = (t) => { ['action','stock','history'].forEach(x => { document.getElementById(`section-${x}`).classList.toggle('hidden', x !== t); document.getElementById(`tab-${x}`).classList.toggle('tab-active', x === t); }); };
        window.stepQty = (v) => { const i = document.getElementById('input-qty'); i.value = Math.max(0, (parseInt(i.value) || 0) + v); };
        window.toggleSettingsManager = (s) => document.getElementById('settings-modal').classList.toggle('hidden', !s);
        window.exportAllData = () => { if (!window.cachedStock) return; let csv = "\uFEFFæ©Ÿç¾¤,Unit,é¡åˆ¥,ä½ç½®/ç”¨é€”,æ–™è™Ÿ,åº«å­˜æ•¸é‡\n"; window.cachedStock.forEach(i => csv += `"${i.group}","${i.unit}","${i.category}","${i.usage||""}","${i.sku}",${i.qty}\n`); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = `Warehouse_Stock.csv`; a.click(); };
        window.startScanner = async () => { document.getElementById('scanner-view').classList.remove('hidden'); html5QrCode = new Html5Qrcode("reader"); await html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 240 }, (t) => { document.getElementById('input-sku').value = t; window.onSkuTyping(t); stopScanner(); }).catch(() => stopScanner()); };
        window.stopScanner = () => { if (html5QrCode) html5QrCode.stop().then(() => document.getElementById('scanner-view').classList.add('hidden')); else document.getElementById('scanner-view').classList.add('hidden'); };
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = "1"; setTimeout(() => t.style.opacity = "0", 2000); }
        document.addEventListener('click', (e) => { if (e.target.id !== 'input-sku') document.getElementById('sku-suggestions').classList.add('hidden'); });
        init();
    </script>
</body>
</html>

