<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤šäººé›²ç«¯å€‰åº«åŠ©æ‰‹</title>
    <!-- æƒæåº« -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 800; }
        ::-webkit-scrollbar { width: 0; background: transparent; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 font-sans">

    <!-- å•Ÿå‹•è¦†è“‹å±¤ (ç”¨æ–¼è¨­ç½®äººå“¡åç¨±) -->
    <div id="setup-overlay" class="fixed inset-0 bg-blue-600 z-[1000] flex items-center justify-center p-6 hidden">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl text-center">
            <h2 class="text-2xl font-black mb-2 text-slate-800">æ­¡è¿ä½¿ç”¨</h2>
            <p class="text-slate-500 text-sm mb-6">è«‹è¼¸å…¥æ­¤æ‰‹æ©Ÿçš„åç¨±æˆ–æ“ä½œå“¡å§“åï¼Œä»¥ä¾¿è¿½è¹¤æ­·å²ç´€éŒ„ã€‚</p>
            <input type="text" id="operator-name-input" placeholder="ä¾‹å¦‚ï¼šå€‰ç®¡-å°æ˜" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 mb-4 outline-none focus:border-blue-500 text-center font-bold">
            <button onclick="saveOperatorName()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-100">é–‹å§‹ç›¤é»</button>
        </div>
    </div>

    <!-- å°èˆªæ¬„ -->
    <nav class="bg-white border-b border-slate-200 px-4 py-3 sticky top-0 z-50 flex justify-between items-center shadow-sm">
        <div class="flex flex-col">
            <span class="text-xs font-black text-blue-600 uppercase tracking-tighter">Shared IMS</span>
            <span id="display-operator" class="text-sm font-bold text-slate-700">è¼‰å…¥ä¸­...</span>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleCategoryManager(true)" class="p-2 bg-slate-100 rounded-lg text-slate-600">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2H2v10h10V2zM22 2h-10v10h10V2zM12 12H2v10h10V12zM22 12h-10v10h10V12z"/></svg>
            </button>
            <button onclick="exportAllData()" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold">åŒ¯å‡º</button>
        </div>
    </nav>

    <main class="max-w-md mx-auto p-4 space-y-4">
        
        <!-- åˆ†é åˆ‡æ› -->
        <div class="flex bg-white rounded-xl p-1 shadow-sm border border-slate-100">
            <button onclick="switchTab('action')" id="tab-action" class="flex-1 py-2 text-sm font-bold tab-active">æ“ä½œ</button>
            <button onclick="switchTab('stock')" id="tab-stock" class="flex-1 py-2 text-sm font-bold text-slate-400">ç¾å­˜åº«å­˜</button>
            <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-2 text-sm font-bold text-slate-400">æ­·å²æ—¥èªŒ</button>
        </div>

        <!-- 1. æ“ä½œé¢æ¿ -->
        <div id="section-action" class="space-y-4">
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 space-y-4">
                <div class="flex gap-2">
                    <button onclick="setMode('IN')" id="mode-in" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold text-sm">å…¥åº«</button>
                    <button onclick="setMode('OUT')" id="mode-out" class="flex-1 py-2 rounded-lg bg-slate-100 text-slate-500 font-bold text-sm">å‡ºåº«</button>
                    <button onclick="setMode('COUNT')" id="mode-count" class="flex-1 py-2 rounded-lg bg-slate-100 text-slate-500 font-bold text-sm">ç›¤é»</button>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">é¡åˆ¥</label>
                        <select id="input-category" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-slate-800 outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                        </select>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">æ–™è™Ÿ / æ¢ç¢¼</label>
                        <div class="flex gap-2">
                            <input type="text" id="input-sku" placeholder="æƒææˆ–æ‰‹å‹•è¼¸å…¥..." class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3 text-slate-800 outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="startScanner()" class="bg-blue-100 text-blue-600 p-3 rounded-xl">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"/></svg>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">æ•¸é‡</label>
                        <div class="flex items-center bg-slate-50 rounded-xl p-1">
                            <button onclick="stepQty(-1)" class="w-12 h-10 bg-white rounded-lg shadow-sm font-bold">-</button>
                            <input type="number" id="input-qty" value="1" class="flex-1 bg-transparent text-center font-black text-lg outline-none">
                            <button onclick="stepQty(1)" class="w-12 h-10 bg-white rounded-lg shadow-sm font-bold">+</button>
                        </div>
                    </div>

                    <button id="btn-submit" onclick="submitTransaction()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-xl shadow-blue-100 active:scale-95 transition-all">
                        ç¢ºèªå…¥åº«
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. ç¾å­˜åº«å­˜ -->
        <div id="section-stock" class="hidden space-y-3">
            <div id="stock-list" class="space-y-2 text-sm text-slate-500">è¼‰å…¥é›²ç«¯æ•¸æ“šä¸­...</div>
        </div>

        <!-- 3. æ­·å²æ—¥èªŒ -->
        <div id="section-history" class="hidden space-y-3">
            <div id="history-list" class="space-y-2 text-sm text-slate-500 text-center">æ­·å²è¼‰å…¥ä¸­...</div>
        </div>

    </main>

    <!-- æƒæå™¨å…¨è¢å¹• -->
    <div id="scanner-view" class="fixed inset-0 bg-black z-[2000] hidden flex flex-col">
        <div id="reader" class="flex-1"></div>
        <div class="p-8 bg-black text-center">
            <button onclick="stopScanner()" class="bg-red-600 text-white px-8 py-4 rounded-2xl font-bold">çµæŸæƒæ</button>
        </div>
    </div>

    <!-- é¡åˆ¥ç®¡ç†å½ˆçª— -->
    <div id="category-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-6" onclick="toggleCategoryManager(false)">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 space-y-4" onclick="event.stopPropagation()">
            <h3 class="text-xl font-black">è‡ªå®šç¾©é¡åˆ¥</h3>
            <div class="flex gap-2">
                <input type="text" id="new-category-name" placeholder="è¼¸å…¥æ–°é¡åˆ¥" class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-2 outline-none">
                <button onclick="addNewCategory()" class="bg-blue-600 text-white px-4 rounded-xl font-bold">+</button>
            </div>
            <div id="category-list-manager" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                <!-- é¡åˆ¥æ¸…å–® -->
            </div>
            <button onclick="toggleCategoryManager(false)" class="w-full py-3 bg-slate-100 rounded-xl font-bold">é—œé–‰</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full text-sm font-bold opacity-0 transition-all z-[3000]"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, serverTimestamp, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'shared-inventory';

        // ç‹€æ…‹
        let user = null;
        let operatorName = localStorage.getItem('ims_operator_name');
        let currentMode = 'IN';
        let categories = ['åŸ¹æ—', 'æ°£å£“ç¼¸', 'èºçµ²', 'è€—æ', 'å…¶ä»–'];
        let html5QrCode = null;

        // å•Ÿå‹•æµç¨‹
        async function init() {
            if (!operatorName) {
                document.getElementById('setup-overlay').classList.remove('hidden');
            } else {
                document.getElementById('display-operator').innerText = `ğŸ‘¤ ${operatorName}`;
            }

            // åŒ¿åç™»å…¥ (Firestore å¿…è¦)
            try {
                await signInAnonymously(auth);
            } catch (e) {
                alert("è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
            }

            onAuthStateChanged(auth, (u) => {
                if (u) {
                    user = u;
                    loadSystemData();
                }
            });
        }

        // å„²å­˜æ“ä½œå“¡å§“å
        window.saveOperatorName = () => {
            const name = document.getElementById('operator-name-input').value.trim();
            if (!name) return alert("è«‹è¼¸å…¥åç¨±");
            localStorage.setItem('ims_operator_name', name);
            operatorName = name;
            document.getElementById('display-operator').innerText = `ğŸ‘¤ ${name}`;
            document.getElementById('setup-overlay').classList.add('hidden');
        };

        // é›²ç«¯æ•¸æ“šåŒæ­¥
        function loadSystemData() {
            if (!user) return;

            // 1. åŒæ­¥é¡åˆ¥åˆ—è¡¨
            const catDoc = doc(db, 'artifacts', appId, 'public', 'settings', 'categories');
            onSnapshot(catDoc, (snapshot) => {
                if (snapshot.exists()) {
                    categories = snapshot.data().list || [];
                } else {
                    // ç¬¬ä¸€æ¬¡åˆå§‹åŒ–
                    setDoc(catDoc, { list: categories });
                }
                renderCategoryOptions();
            }, (e) => console.error(e));

            // 2. åŒæ­¥å³æ™‚åº«å­˜
            const stockCol = collection(db, 'artifacts', appId, 'public', 'data', 'stock');
            onSnapshot(stockCol, (snapshot) => {
                const stockData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderStockList(stockData);
                window.allStockData = stockData; // ç”¨æ–¼å›å¡«
            }, (e) => console.error(e));

            // 3. åŒæ­¥æ­·å²ç´€éŒ„ (è¦å‰‡ 2: æŠ“å–å…¨éƒ¨å¾Œåœ¨å‰ç«¯æ’)
            const historyCol = collection(db, 'artifacts', appId, 'public', 'data', 'history');
            onSnapshot(historyCol, (snapshot) => {
                const logs = snapshot.docs.map(d => d.data());
                // æŒ‰æ™‚é–“æ’åº
                logs.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderHistoryList(logs);
            }, (e) => console.error(e));
        }

        // æäº¤äº¤æ˜“
        window.submitTransaction = async () => {
            const sku = document.getElementById('input-sku').value.trim();
            const qty = parseInt(document.getElementById('input-qty').value);
            const category = document.getElementById('input-category').value;

            if (!sku || !qty) return showToast("âŒ è«‹å®Œæ•´å¡«å¯«æ–™è™Ÿèˆ‡æ•¸é‡");

            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = "æäº¤ä¸­...";

            try {
                const stockDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku);
                const stockSnap = await getDoc(stockDocRef);
                
                let newQty = qty;
                let currentStock = 0;

                if (stockSnap.exists()) {
                    currentStock = stockSnap.data().qty || 0;
                    if (currentMode === 'IN') newQty = currentStock + qty;
                    else if (currentMode === 'OUT') newQty = currentStock - qty;
                    // å¦‚æœæ˜¯ COUNTï¼Œå°±ç›´æ¥ç”¨è¼¸å…¥çš„ qty
                }

                // æ›´æ–°åº«å­˜
                await setDoc(stockDocRef, {
                    sku,
                    qty: newQty,
                    category,
                    lastUpdated: serverTimestamp(),
                    lastOperator: operatorName
                });

                // å¯«å…¥æ­·å²ç´€éŒ„
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), {
                    sku,
                    type: currentMode,
                    change: qty,
                    after: newQty,
                    operator: operatorName,
                    category: category,
                    timestamp: serverTimestamp()
                });

                showToast(`âœ… ${sku} å·²æ›´æ–°ç‚º ${newQty}`);
                document.getElementById('input-sku').value = "";
                document.getElementById('input-qty').value = "1";
            } catch (e) {
                showToast("âŒ é›²ç«¯æ›´æ–°å¤±æ•—");
                console.error(e);
            } finally {
                btn.disabled = false;
                setMode(currentMode); // æ¢å¾©æŒ‰éˆ•æ–‡å­—
            }
        };

        // UI æ¸²æŸ“èˆ‡æ§åˆ¶
        function renderCategoryOptions() {
            const select = document.getElementById('input-category');
            const manager = document.getElementById('category-list-manager');
            
            select.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            manager.innerHTML = categories.map(c => `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <span class="font-bold">${c}</span>
                    <button onclick="removeCategory('${c}')" class="text-red-500 font-black text-lg">Ã—</button>
                </div>
            `).join('');
        }

        function renderStockList(data) {
            const list = document.getElementById('stock-list');
            if (data.length === 0) {
                list.innerHTML = `<div class="text-center py-20 text-slate-300">ç›®å‰é›²ç«¯ç„¡ä»»ä½•åº«å­˜è³‡æ–™</div>`;
                return;
            }

            list.innerHTML = data.map(item => `
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center active:scale-[0.98] transition-all" onclick="autoFill('${item.sku}', '${item.category}')">
                    <div class="space-y-0.5">
                        <span class="text-[10px] font-black bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full uppercase">${item.category}</span>
                        <div class="text-lg font-black text-slate-800">${item.sku}</div>
                        <div class="text-[10px] text-slate-400">æœ€å¾Œç”± ${item.lastOperator || 'ç³»çµ±'} æ›´æ–°</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-slate-400 font-bold uppercase">Stock</div>
                        <div class="text-2xl font-black ${item.qty < 0 ? 'text-red-500' : 'text-slate-900'}">${item.qty}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderHistoryList(logs) {
            const list = document.getElementById('history-list');
            if (logs.length === 0) {
                list.innerHTML = `<div class="py-20 text-slate-300">å°šç„¡æ­·å²æ“ä½œç´€éŒ„</div>`;
                return;
            }

            list.innerHTML = logs.slice(0, 50).map(log => {
                const time = log.timestamp ? new Date(log.timestamp.toMillis()).toLocaleString() : 'è™•ç†ä¸­...';
                const typeColor = { 'IN': 'text-blue-600', 'OUT': 'text-orange-500', 'COUNT': 'text-emerald-600' }[log.type];
                const typeText = { 'IN': 'å…¥åº«', 'OUT': 'å‡ºåº«', 'COUNT': 'ç›¤é»' }[log.type];
                
                return `
                    <div class="bg-white p-4 rounded-xl border border-slate-50 shadow-sm flex flex-col gap-1">
                        <div class="flex justify-between items-start">
                            <span class="text-xs font-bold ${typeColor} bg-slate-50 px-2 py-0.5 rounded">${typeText}</span>
                            <span class="text-[10px] text-slate-300">${time}</span>
                        </div>
                        <div class="flex justify-between items-end">
                            <div>
                                <div class="font-black text-slate-800">${log.sku}</div>
                                <div class="text-[10px] text-slate-400">æ“ä½œäºº: ${log.operator}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-bold text-slate-800">${log.type === 'OUT' ? '-' : '+'}${log.change} ä»¶</div>
                                <div class="text-[10px] text-slate-400">çµå­˜: ${log.after}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // å…¨åŸŸå‡½æ•¸
        window.switchTab = (tab) => {
            ['action', 'stock', 'history'].forEach(t => {
                document.getElementById(`section-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
            });
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
        };

        window.setMode = (m) => {
            currentMode = m;
            const modes = ['in', 'out', 'count'];
            const colors = { in: 'bg-blue-600', out: 'bg-orange-500', count: 'bg-emerald-600' };
            const labels = { in: 'ç¢ºèªå…¥åº«', out: 'ç¢ºèªå‡ºåº«', count: 'æ›´æ–°ç›¤é»æ•¸' };

            modes.forEach(mode => {
                const el = document.getElementById(`mode-${mode}`);
                if (mode === m.toLowerCase()) {
                    el.className = `flex-1 py-2 rounded-lg ${colors[mode]} text-white font-bold text-sm transition-colors`;
                } else {
                    el.className = `flex-1 py-2 rounded-lg bg-slate-100 text-slate-500 font-bold text-sm transition-colors`;
                }
            });

            document.getElementById('btn-submit').innerText = labels[m.toLowerCase()];
            document.getElementById('btn-submit').style.backgroundColor = colors[m.toLowerCase()];
        };

        window.stepQty = (val) => {
            const i = document.getElementById('input-qty');
            i.value = Math.max(1, (parseInt(i.value) || 0) + val);
        };

        window.autoFill = (sku, cat) => {
            document.getElementById('input-sku').value = sku;
            document.getElementById('input-category').value = cat;
            switchTab('action');
            showToast(`å·²è¼‰å…¥æ–™è™Ÿ ${sku}`);
        };

        window.toggleCategoryManager = (show) => {
            document.getElementById('category-modal').classList.toggle('hidden', !show);
        };

        window.addNewCategory = async () => {
            const name = document.getElementById('new-category-name').value.trim();
            if (!name || categories.includes(name)) return;
            const updated = [...categories, name];
            await setDoc(doc(db, 'artifacts', appId, 'public', 'settings', 'categories'), { list: updated });
            document.getElementById('new-category-name').value = "";
        };

        window.removeCategory = async (name) => {
            if (!confirm(`ç¢ºå®šè¦ç§»é™¤é¡åˆ¥ã€Œ${name}ã€å—ï¼Ÿé€™ä¸æœƒåˆªé™¤å·²å­˜åœ¨çš„æ–™è™Ÿæ•¸æ“šã€‚`)) return;
            const updated = categories.filter(c => c !== name);
            await setDoc(doc(db, 'artifacts', appId, 'public', 'settings', 'categories'), { list: updated });
        };

        window.startScanner = async () => {
            document.getElementById('scanner-view').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            try {
                await html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, (text) => {
                    document.getElementById('input-sku').value = text;
                    stopScanner();
                });
            } catch (e) {
                alert("ç›¸æ©Ÿç•°å¸¸ï¼Œè«‹ç¢ºä¿ HTTPS é€£ç·šä¸¦æˆæ¬Šç›¸æ©Ÿ");
                stopScanner();
            }
        };

        window.stopScanner = () => {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-view').classList.add('hidden');
                }).catch(() => {
                    document.getElementById('scanner-view').classList.add('hidden');
                });
            } else {
                document.getElementById('scanner-view').classList.add('hidden');
            }
        };

        window.exportAllData = () => {
            if (!window.allStockData || window.allStockData.length === 0) return alert("å°šç„¡è³‡æ–™");
            let csv = "\uFEFFæ–™è™Ÿ,é¡åˆ¥,ç•¶å‰åº«å­˜,æœ€å¾Œæ›´æ–°äºº\n";
            window.allStockData.forEach(item => {
                csv += `"${item.sku}","${item.category}",${item.qty},"${item.lastOperator}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `CloudInventory_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = "1";
            t.style.transform = "translate(-50%, -20px)";
            setTimeout(() => {
                t.style.opacity = "0";
                t.style.transform = "translate(-50%, 0)";
            }, 2000);
        }

        init();
    </script>
</body>
</html>

