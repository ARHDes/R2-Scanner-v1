<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤šäººé›²ç«¯å€‰åº«åŠ©æ‰‹ V8.0 - ç®¡ç†å“¡ç‰ˆ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 800; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .suggestion-item { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .suggestion-item:active { background: #eff6ff; }
        .admin-glow { box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); border: 1px solid rgba(245, 158, 11, 0.5); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 font-sans text-slate-900">

    <!-- äººå“¡è¨­ç½® -->
    <div id="setup-overlay" class="fixed inset-0 bg-blue-600 z-[1000] flex items-center justify-center p-6 hidden">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl text-center">
            <h2 class="text-2xl font-black mb-2 text-slate-800">èº«åˆ†ç™»éŒ„</h2>
            <p class="text-slate-500 text-sm mb-6">è«‹è¼¸å…¥æ‚¨çš„å“¡ç·¨æˆ–å§“åä»¥é–‹å§‹ä½œæ¥­ã€‚</p>
            <input type="text" id="operator-name-input" placeholder="äººå“¡åç¨±æˆ–ç®¡ç†å“¡ç·¨è™Ÿ" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 mb-4 outline-none focus:border-blue-500 text-center font-bold">
            <button onclick="saveOperatorName()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-all">é€²å…¥ç³»çµ±</button>
        </div>
    </div>

    <!-- å°èˆªæ¬„ -->
    <nav id="top-nav" class="bg-white border-b border-slate-200 px-4 py-3 sticky top-0 z-50 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-2">
            <div class="flex flex-col">
                <span id="admin-badge" class="hidden text-[8px] font-black bg-amber-500 text-white px-1.5 py-0.5 rounded-full w-fit mb-0.5 uppercase tracking-tighter">Admin Mode</span>
                <span id="display-operator" class="text-sm font-bold text-slate-700">é€£ç·šä¸­...</span>
            </div>
        </div>
        <div class="flex items-center gap-1.5">
            <!-- ç®¡ç†å“¡å°ˆå±¬æŒ‰éˆ• -->
            <button id="admin-toggle-btn" onclick="toggleAdminMode()" class="hidden p-2 bg-amber-50 text-amber-600 rounded-lg active:scale-90 transition-all border border-amber-100">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            </button>
            <button onclick="toggleCategoryManager(true)" class="p-2 bg-slate-100 rounded-lg text-slate-600 active:scale-90 transition-all">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            </button>
            <button onclick="logout()" class="p-2 bg-red-50 text-red-500 rounded-lg active:scale-90 transition-all border border-red-100">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>
            </button>
        </div>
    </nav>

    <main class="max-w-md mx-auto p-4 space-y-4">
        <div class="flex bg-white rounded-xl p-1 shadow-sm border border-slate-100">
            <button onclick="switchTab('action')" id="tab-action" class="flex-1 py-2 text-sm font-bold tab-active">æ“ä½œ</button>
            <button onclick="switchTab('stock')" id="tab-stock" class="flex-1 py-2 text-sm font-bold text-slate-400">å³æ™‚åº«å­˜</button>
            <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-2 text-sm font-bold text-slate-400">æ­·å²ç´€éŒ„</button>
        </div>

        <!-- 1. æ“ä½œåˆ†é  -->
        <div id="section-action" class="space-y-4">
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 space-y-4">
                <div class="flex gap-2 p-1 bg-slate-50 rounded-xl">
                    <button onclick="setMode('IN')" id="mode-in" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold text-xs">å…¥åº«</button>
                    <button onclick="setMode('OUT')" id="mode-out" class="flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs">å‡ºåº«</button>
                    <button onclick="setMode('COUNT')" id="mode-count" class="flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs">ç›¤é»</button>
                </div>
                
                <div class="space-y-3 relative">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">é¡åˆ¥</label>
                            <select id="input-category" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold text-slate-800 outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">ç”¨é€”</label>
                            <input type="text" id="input-usage" placeholder="å‚™è¨»..." class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">æ–™è™Ÿ / æ¢ç¢¼</label>
                        <div class="flex gap-2">
                            <input type="text" id="input-sku" oninput="onSkuTyping(this.value)" placeholder="è¼¸å…¥æ–™è™Ÿ..." class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                            <button onclick="startScanner()" class="bg-blue-100 text-blue-600 p-3 rounded-xl active:scale-90 transition-transform">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"></path></svg>
                            </button>
                        </div>
                        <div id="sku-suggestions" class="absolute left-0 right-0 bg-white border border-slate-200 rounded-xl shadow-xl z-50 mt-1 hidden max-h-60 overflow-y-auto"></div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">æ•¸é‡</label>
                        <div class="flex items-center bg-slate-50 rounded-xl p-1">
                            <button onclick="stepQty(-1)" class="w-12 h-10 bg-white rounded-lg shadow-sm font-bold text-xl active:bg-slate-50">-</button>
                            <input type="number" id="input-qty" value="1" class="flex-1 bg-transparent text-center font-black text-xl outline-none">
                            <button onclick="stepQty(1)" class="w-12 h-10 bg-white rounded-lg shadow-sm font-bold text-xl active:bg-slate-50">+</button>
                        </div>
                    </div>

                    <button id="btn-submit" onclick="submitTransaction()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-xl shadow-blue-100 active:scale-95 transition-all">ç¢ºèªæäº¤</button>
                </div>
            </div>
        </div>

        <!-- 2. åº«å­˜åˆ†é  -->
        <div id="section-stock" class="hidden space-y-3">
            <div class="flex justify-between items-center px-1">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">é›²ç«¯å³æ™‚æ¸…å–®</span>
                <div class="flex gap-2">
                    <button onclick="triggerImport()" class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-lg text-xs font-bold border border-emerald-100 active:scale-95">åŒ¯å…¥</button>
                    <button onclick="exportAllData()" class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold border border-blue-100 active:scale-95">ä¸‹è¼‰</button>
                </div>
                <input type="file" id="csv-file-input" class="hidden" accept=".csv" onchange="handleFileSelect(event)">
            </div>
            <div id="stock-list" class="space-y-2"></div>
        </div>

        <!-- 3. æ­·å²åˆ†é  -->
        <div id="section-history" class="hidden space-y-3">
            <div id="history-list" class="space-y-2"></div>
        </div>
    </main>

    <!-- Modal å½ˆçª—å€ -->
    <div id="scanner-view" class="fixed inset-0 bg-black z-[2000] hidden flex flex-col">
        <div id="reader" class="flex-1"></div>
        <div class="p-10 bg-black text-center">
            <button onclick="stopScanner()" class="bg-red-600 text-white px-10 py-4 rounded-2xl font-black">é—œé–‰æƒæ</button>
        </div>
    </div>

    <div id="category-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-6" onclick="toggleCategoryManager(false)">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 space-y-4 shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-lg font-black text-slate-800">é¡åˆ¥ç¶­è­·</h3>
            <div id="admin-cat-controls" class="hidden space-y-4">
                <div class="flex gap-2">
                    <input type="text" id="new-category-name" placeholder="è¼¸å…¥æ–°åç¨±..." class="flex-1 bg-slate-50 rounded-xl px-4 py-2 text-sm outline-none border border-transparent focus:border-blue-500">
                    <button onclick="addNewCategory()" class="bg-blue-600 text-white px-4 rounded-xl font-bold active:scale-90">+</button>
                </div>
            </div>
            <div id="category-list-manager" class="space-y-2 max-h-60 overflow-y-auto pr-1"></div>
            <button onclick="toggleCategoryManager(false)" class="w-full py-3 bg-slate-100 rounded-xl font-bold text-slate-500 text-sm">é—œé–‰</button>
        </div>
    </div>

    <!-- ç¢ºèªå½ˆçª— -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[3000] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 space-y-4 shadow-2xl text-center">
            <div id="confirm-icon" class="w-16 h-16 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-2">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01"/></svg>
            </div>
            <h3 id="confirm-title" class="text-lg font-black text-slate-800">æ¨™é¡Œ</h3>
            <p id="confirm-modal-msg" class="text-sm text-slate-500 leading-relaxed"></p>
            <div class="flex gap-3 pt-2">
                <button onclick="closeConfirmModal(false)" class="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-500">å–æ¶ˆ</button>
                <button id="confirm-ok-btn" onclick="closeConfirmModal(true)" class="flex-1 py-3 bg-blue-600 rounded-xl font-bold text-white shadow-lg">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur text-white px-6 py-3 rounded-full text-xs font-bold opacity-0 transition-all z-[4000] pointer-events-none shadow-2xl"></div>

    <!-- Firebase é‚è¼¯ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, serverTimestamp, getDoc, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDlrIJR7wKN_lzcTiC2ohe8jeXaC3mZXdk",
            authDomain: "storage-3098e.firebaseapp.com",
            projectId: "storage-3098e",
            storageBucket: "storage-3098e.firebasestorage.app",
            messagingSenderId: "947569272384",
            appId: "1:947569272384:web:badb6b78e91e36cee5a1a5",
            measurementId: "G-1WEQXLGR20"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'storage-3098e'; 
        const ADMIN_ID = '22009866';

        let operatorName = localStorage.getItem('ims_op_v7');
        let currentMode = 'IN';
        let adminModeActive = false;
        let categories = [];
        let html5QrCode = null;
        let pendingAction = null;

        async function init() {
            if (!operatorName) {
                document.getElementById('setup-overlay').classList.remove('hidden');
            } else {
                document.getElementById('display-operator').innerText = `ğŸ‘¤ ${operatorName}`;
                checkAdminStatus();
            }
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => { if (u) loadCloudData(); });
            } catch (err) { console.error(err); }
        }

        function checkAdminStatus() {
            if (operatorName === ADMIN_ID) {
                document.getElementById('admin-toggle-btn').classList.remove('hidden');
                document.getElementById('admin-cat-controls').classList.remove('hidden');
                document.getElementById('display-operator').classList.add('text-amber-600');
            }
        }

        window.saveOperatorName = () => {
            const name = document.getElementById('operator-name-input').value.trim();
            if (!name) return;
            localStorage.setItem('ims_op_v7', name);
            operatorName = name;
            location.reload();
        };

        window.logout = () => {
            if (confirm("ç¢ºå®šè¦ç™»å‡ºä¸¦åˆ‡æ›ä½¿ç”¨è€…å—ï¼Ÿ")) {
                localStorage.removeItem('ims_op_v7');
                location.reload();
            }
        };

        window.toggleAdminMode = () => {
            adminModeActive = !adminModeActive;
            const nav = document.getElementById('top-nav');
            const badge = document.getElementById('admin-badge');
            
            if (adminModeActive) {
                nav.classList.add('admin-glow', 'bg-amber-50');
                badge.classList.remove('hidden');
                showToast("âš ï¸ å·²é€²å…¥ç®¡ç†æ¨¡å¼");
            } else {
                nav.classList.remove('admin-glow', 'bg-amber-50');
                badge.classList.add('hidden');
                showToast("å·²é€€å‡ºç®¡ç†æ¨¡å¼");
            }
            renderStock(window.cachedStock || []);
            renderCats();
        };

        function loadCloudData() {
            const catRef = doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all');
            onSnapshot(catRef, (s) => {
                if (s.exists()) {
                    categories = s.data().list || [];
                    renderCats();
                } else {
                    setDoc(catRef, { list: ['åŸ¹æ—', 'æ°£å£“ç¼¸', 'èºçµ²', 'è€—æ'] });
                }
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'stock'), (s) => {
                const data = s.docs.map(d => d.data());
                window.cachedStock = data;
                renderStock(data);
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'history'), (s) => {
                const logs = s.docs.map(d => d.data()).sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderHistory(logs);
            });
        }

        // --- æ ¸å¿ƒé‚è¼¯ï¼šå»ºè­°æ¸…å–®èˆ‡å±¬æ€§æª¢æŸ¥ ---
        window.onSkuTyping = (val) => {
            const container = document.getElementById('sku-suggestions');
            if (!val || !window.cachedStock) {
                container.classList.add('hidden');
                return;
            }
            const matches = window.cachedStock.filter(i => i.sku.toLowerCase().includes(val.toLowerCase())).slice(0, 10);
            if (matches.length > 0) {
                container.innerHTML = matches.map(i => `
                    <div class="suggestion-item" onclick="applySuggestion('${i.sku}')">
                        <div class="font-bold text-slate-800 text-sm">${i.sku}</div>
                        <div class="text-[9px] text-slate-400">${i.category} â€¢ ${i.usage || 'ç„¡ç”¨é€”'}</div>
                    </div>`).join('');
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
            // è‡ªå‹•å¸¶å…¥
            const exact = window.cachedStock.find(i => i.sku.toLowerCase() === val.trim().toLowerCase());
            if (exact) {
                document.getElementById('input-category').value = exact.category;
                document.getElementById('input-usage').value = exact.usage || "";
            }
        };

        window.applySuggestion = (sku) => {
            const item = window.cachedStock.find(i => i.sku === sku);
            if (item) {
                document.getElementById('input-sku').value = item.sku;
                document.getElementById('input-category').value = item.category;
                document.getElementById('input-usage').value = item.usage || "";
                document.getElementById('sku-suggestions').classList.add('hidden');
            }
        };

        window.submitTransaction = async () => {
            const sku = document.getElementById('input-sku').value.trim();
            const usage = document.getElementById('input-usage').value.trim();
            const qty = parseInt(document.getElementById('input-qty').value) || 0;
            const cat = document.getElementById('input-category').value;

            if (!sku || qty <= 0) return showToast("âš ï¸ è«‹è¼¸å…¥æ–™è™Ÿèˆ‡æ•¸é‡");

            const existing = window.cachedStock.find(i => i.sku === sku);
            if (existing && (existing.category !== cat || (existing.usage || "") !== usage)) {
                pendingAction = { type: 'OVERWRITE', data: { sku, cat, usage, qty } };
                showConfirm("åµæ¸¬åˆ°å±¬æ€§è®Šæ›´", 
                    `æ–™è™Ÿ <b>${sku}</b> å·²å­˜åœ¨ä¸”å±¬æ€§ä¸åŒï¼š<br>` +
                    `é¡åˆ¥ï¼š${existing.category} â” ${cat}<br>` +
                    `ç”¨é€”ï¼š${existing.usage||'ç„¡'} â” ${usage||'ç„¡'}<br><br>` +
                    `æ˜¯å¦ç¢ºå®šè¦æ›´æ–°å±¬æ€§ä¸¦ç¹¼çºŒï¼Ÿ`, "#f59e0b", "ç¢ºå®šè¦†è“‹");
                return;
            }
            executeCommit(sku, cat, usage, qty);
        };

        async function executeCommit(sku, cat, usage, qty) {
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            try {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku);
                const snap = await getDoc(ref);
                let oldQty = snap.exists() ? snap.data().qty : 0;
                let newQty = currentMode === 'IN' ? oldQty + qty : (currentMode === 'OUT' ? oldQty - qty : qty);

                await setDoc(ref, { sku, qty: newQty, category: cat, usage, lastOp: operatorName, time: serverTimestamp() });
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history'), {
                    sku, type: currentMode, change: qty, after: newQty, op: operatorName, cat, usage, timestamp: serverTimestamp()
                });

                showToast(`âœ… ${sku} æ›´æ–°æˆåŠŸ`);
                document.getElementById('input-sku').value = "";
                document.getElementById('input-usage').value = "";
                document.getElementById('input-qty').value = "1";
            } catch (e) { showToast("âŒ æ›´æ–°å¤±æ•—"); }
            finally { btn.disabled = false; setMode(currentMode); }
        }

        // --- ç®¡ç†å“¡åˆªé™¤åŠŸèƒ½ ---
        window.deleteStockItem = (sku) => {
            pendingAction = { type: 'DELETE_SKU', data: { sku } };
            showConfirm("åˆªé™¤æ–™è™Ÿ", `ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ–™è™Ÿ <b>${sku}</b> çš„æ‰€æœ‰åº«å­˜è³‡æ–™å—ï¼Ÿé€™ç„¡æ³•å¾©åŸã€‚`, "#ef4444", "ç¢ºå®šåˆªé™¤");
        };

        function showConfirm(title, msg, color, btnText) {
            const modal = document.getElementById('confirm-modal');
            const icon = document.getElementById('confirm-icon');
            const okBtn = document.getElementById('confirm-ok-btn');
            
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-modal-msg').innerHTML = msg;
            icon.style.color = color;
            okBtn.style.backgroundColor = color;
            okBtn.innerText = btnText;
            modal.classList.remove('hidden');
        }

        window.closeConfirmModal = async (confirm) => {
            document.getElementById('confirm-modal').classList.add('hidden');
            if (confirm && pendingAction) {
                if (pendingAction.type === 'OVERWRITE') {
                    const { sku, cat, usage, qty } = pendingAction.data;
                    executeCommit(sku, cat, usage, qty);
                } else if (pendingAction.type === 'DELETE_SKU') {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stock', pendingAction.data.sku));
                        showToast(`ğŸ—‘ï¸ å·²åˆªé™¤æ–™è™Ÿ: ${pendingAction.data.sku}`);
                    } catch (e) { showToast("âŒ åˆªé™¤å¤±æ•—"); }
                }
            }
            pendingAction = null;
        };

        // --- UI æ¸²æŸ“ ---
        function renderCats() {
            const sel = document.getElementById('input-category');
            const mgr = document.getElementById('category-list-manager');
            sel.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            mgr.innerHTML = categories.map(c => `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <span class="font-bold text-sm">${c}</span>
                    ${adminModeActive ? `<button onclick="removeCategory('${c}')" class="text-red-500 font-bold text-xs bg-red-50 px-2 py-1 rounded">ç§»é™¤</button>` : ''}
                </div>`).join('');
        }

        function renderStock(data) {
            const list = document.getElementById('stock-list');
            if (!data.length) return list.innerHTML = '<div class="text-center py-20 text-slate-300">æ¸…å–®ç‚ºç©º</div>';
            list.innerHTML = data.map(i => `
                <div class="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center shadow-sm" onclick="applySuggestion('${i.sku}'); switchTab('action');">
                    <div class="flex-1 pr-2">
                        <div class="flex items-center gap-1.5 mb-1">
                            <span class="text-[8px] font-black bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded uppercase">${i.category}</span>
                            ${i.usage ? `<span class="text-[8px] font-bold bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded italic">ç”¨ï¼š${i.usage}</span>` : ''}
                        </div>
                        <div class="font-black text-slate-800 text-sm break-all">${i.sku}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-xl font-black ${i.qty < 0 ? 'text-red-500' : 'text-slate-800'}">${i.qty}</div>
                        ${adminModeActive ? `<button onclick="event.stopPropagation(); deleteStockItem('${i.sku}')" class="p-2 bg-red-50 text-red-500 rounded-lg active:scale-90"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>` : ''}
                    </div>
                </div>`).join('');
        }

        function renderHistory(logs) {
            const list = document.getElementById('history-list');
            list.innerHTML = logs.slice(0, 30).map(l => `
                <div class="bg-white p-3 rounded-xl border border-slate-50 flex justify-between items-center text-[10px] shadow-sm">
                    <div><div class="font-bold text-slate-800">${l.sku}</div><div class="text-slate-400">${l.op} â€¢ ${l.timestamp ? new Date(l.timestamp.toMillis()).toLocaleTimeString() : '...'}</div></div>
                    <div class="font-black ${l.type==='IN'?'text-blue-500':(l.type==='OUT'?'text-orange-500':'text-emerald-500')}">${l.type} ${l.change}</div>
                </div>`).join('');
        }

        window.setMode = (m) => {
            currentMode = m;
            ['IN','OUT','COUNT'].forEach(x => {
                document.getElementById(`mode-${x.toLowerCase()}`).className = x === m ? 'flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold text-xs' : 'flex-1 py-2 rounded-lg text-slate-400 font-bold text-xs';
            });
            const btn = document.getElementById('btn-submit');
            btn.innerText = m==='IN'?'ç¢ºèªå…¥åº«':(m==='OUT'?'ç¢ºèªå‡ºåº«':'ä¿®æ­£å­˜é‡');
            btn.style.backgroundColor = m==='IN'?'#2563eb':(m==='OUT'?'#f97316':'#10b981');
        };

        window.switchTab = (t) => {
            ['action','stock','history'].forEach(x => {
                document.getElementById(`section-${x}`).classList.toggle('hidden', x !== t);
                document.getElementById(`tab-${x}`).classList.toggle('tab-active', x === t);
            });
        };

        window.stepQty = (v) => {
            const i = document.getElementById('input-qty');
            i.value = Math.max(1, (parseInt(i.value) || 0) + v);
        };

        window.toggleCategoryManager = (s) => document.getElementById('category-modal').classList.toggle('hidden', !s);
        window.addNewCategory = async () => {
            const n = document.getElementById('new-category-name').value.trim();
            if (!n || categories.includes(n)) return;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), { list: [...categories, n] });
            document.getElementById('new-category-name').value = "";
        };

        window.removeCategory = async (n) => {
            if (confirm(`ç§»é™¤é¡åˆ¥ã€Œ${n}ã€ï¼Ÿ`)) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), { list: categories.filter(x => x !== n) });
        };

        window.exportAllData = () => {
            if (!window.cachedStock) return;
            let csv = "\uFEFFæ–™è™Ÿ,é¡åˆ¥,ç”¨é€”,åº«å­˜æ•¸é‡\n";
            window.cachedStock.forEach(i => csv += `"${i.sku}","${i.category}","${i.usage||""}",${i.qty}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CloudInventory.csv`;
            a.click();
        };

        window.triggerImport = () => document.getElementById('csv-file-input').click();
        window.handleFileSelect = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => { await processCSV(e.target.result); event.target.value = ''; };
            reader.readAsText(file);
        };

        async function processCSV(csvText) {
            showToast("â³ åŒ¯å…¥ä¸­...");
            const rows = csvText.split(/\r?\n/).filter(r => r.trim() !== "");
            const batch = writeBatch(db);
            let count = 0;
            let newCats = new Set(categories);
            try {
                for (let i = 1; i < rows.length; i++) {
                    const cols = rows[i].split(",").map(c => c.trim().replace(/^"|"$/g, ""));
                    if (cols.length < 2) continue;
                    const [sku, cat, usage, qtyStr] = cols;
                    const qty = parseInt(qtyStr) || 0;
                    if (!sku) continue;
                    batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'stock', sku), {
                        sku, category: cat || "å…¶ä»–", usage: usage || "", qty, lastOp: operatorName + "(åŒ¯å…¥)", time: serverTimestamp()
                    });
                    if (cat) newCats.add(cat);
                    count++;
                }
                if (newCats.size > categories.length) {
                    batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'all'), { list: Array.from(newCats) });
                }
                await batch.commit();
                showToast(`âœ… æˆåŠŸåŒ¯å…¥ ${count} ç­†`);
            } catch (err) { showToast("âŒ æ ¼å¼ä¸ç¬¦"); }
        }

        window.startScanner = async () => {
            document.getElementById('scanner-view').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            await html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 220 }, (t) => {
                document.getElementById('input-sku').value = t;
                window.onSkuTyping(t);
                stopScanner();
            }).catch(() => stopScanner());
        };

        window.stopScanner = () => {
            if (html5QrCode) html5QrCode.stop().then(() => document.getElementById('scanner-view').classList.add('hidden'));
            else document.getElementById('scanner-view').classList.add('hidden');
        };

        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.opacity = "1";
            setTimeout(() => t.style.opacity = "0", 2000);
        }

        init();
    </script>
</body>
</html>

